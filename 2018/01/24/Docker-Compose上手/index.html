<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>docker-compose上手 &middot; Yeqown</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		<link rel="shortcut icon" href="favicon.ico">
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
		<link rel="stylesheet" href="/highlight/styles/monokai-sublime.css">
		
		<script src="/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Yeqown</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Yeqown</a></li>
        
        <li><a href='/#footer'>Contact</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/yeqown" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        
        
        
        <li><a href="https://github.com/yeqown" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">January 24, 2018</span>
                                
                                <h1>docker-compose上手</h1>
                                <p>docker compose 用于快速在集群中部署分布式应用。</p>
                            </header>
                            
                            <p>docker compose 用于快速在集群中部署分布式应用。按我的理解也可以用于简化部署单个应用。譬如我要使用dock er启动一个nginx服务，需要做端口映射，挂载数据文件，指定镜像&hellip;等等，这种情况下，可以将启动容器的命令整合到docker-compose.yml文件中，可以在多个服务器上运行，瞬间就完成了nginx的安装及配置，再也不用去编译，解决环境依赖了，这种感觉实在是太爽了！！！</p>
<!-- more -->
<h3 id="安装">安装</h3>
<ol>
<li>使用pip <code>pip install docker-compose</code></li>
<li>从官方<a href="https://github.com/docker/compose/releases">Github Release</a>下载二进制包文件</li>
<li>其他方法略去</li>
</ol>
<h3 id="使用场景">使用场景</h3>
<blockquote>
<p>在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括负载均衡容器等。</p>
</blockquote>
<h3 id="实战场景">实战场景</h3>
<p>需要部署的项目，只有两个docker容器，一个server，一个db。一般的部署方式是，分别启动两个容器，容器间通过互联的方式通信：</p>
<pre><code>sudo docker run --rm -p 5433:5432 --name postgres -e POSTGRES_PASSWORD=minepwd -e POSTGRES_USER=mineusr -d postgres

sudo docker run --rm -p 9091:9091 --link postgres:postgres --name mineserver -d me/mineserver
</code></pre><p>这两条命令还是有挺麻烦的，如果记不住，当然可以用shell脚本来运行，可以如果其中某一个服务无法如期运行。。。就很监介了。这时候就可以引入<strong>docker-compose</strong>了。</p>
<h3 id="编写docker-composeyml来部署项目">编写docker-compose.yml来部署项目</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#75715e"># 指定docker-compose版本</span>
<span style="color:#f92672">services</span>:    <span style="color:#75715e"># 项目依赖的服务</span>
  <span style="color:#f92672">postgres</span>:  <span style="color:#75715e"># 服务名字</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">postgres</span> <span style="color:#75715e"># 服务需要的docker镜像与docker run命令中的镜像指定方式一致</span>
    <span style="color:#f92672">volumes</span>:        <span style="color:#75715e"># 挂载卷，这里的主要目的是，方便同步数据库和数据脚本</span>
      - <span style="color:#ae81ff">./postgres:/var/lib/postgresql/data</span>
      - <span style="color:#ae81ff">./sh:/usr/src/sh</span>
    <span style="color:#f92672">ports</span>:          <span style="color:#75715e"># 端口绑定</span>
      - <span style="color:#ae81ff">5433</span>:<span style="color:#ae81ff">5432</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">postgres</span>
    <span style="color:#f92672">environment</span>:    <span style="color:#75715e"># 设置环境变量</span>
      <span style="color:#f92672">POSTGRES_PASSWORD</span>: <span style="color:#e6db74">&#34;minepwd&#34;</span>
      <span style="color:#f92672">POSTGRES_USER</span>: <span style="color:#e6db74">&#34;mineusr&#34;</span>
      <span style="color:#f92672">POSTGRES_DB</span>: <span style="color:#e6db74">&#34;minedb&#34;</span>
  <span style="color:#f92672">mineserver</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">me/mineserver</span>
    <span style="color:#f92672">volumes</span>:        <span style="color:#75715e"># 挂载卷，方便查看输出日志</span>
      - <span style="color:#ae81ff">./logs:/usr/src/mineserver/logs</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#ae81ff">9091</span>:<span style="color:#ae81ff">9091</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">mineserver</span>
    <span style="color:#f92672">links</span>:          <span style="color:#75715e"># 容器互联</span>
      - <span style="color:#ae81ff">postgres:postgres</span>
</code></pre></div><p>在编写docker-compose.yml的时候，需要注意的是各个选项的数据类型，不过docker-compose会有提示，也很方便</p>
<p>这样编写之后，可以直接运行<code>docker-compose up</code>就可以启动两个容器了。输出如下：</p>
<pre><code>➜  mineserver git:(yeqown) docker-compose up
Starting postgres ... done
Starting mineserver ... done
Attaching to postgres, mineserver
mineserver  | 2018/01/25 06:28:02 Loading config: ./configs/config.json
mineserver  | 2018/01/25 06:28:02 init all logger done
mineserver  | 2018/01/25 06:28:02 host=postgres user=mineusr dbname=minedb sslmode=disable password=minepwd
mineserver  | panic: dial tcp 172.18.0.2:5432: getsockopt: connection refused
mineserver  |
mineserver  | goroutine 1 [running]:
mineserver  | mineserver/vendor/app/models.ConnPgsql(0xc4200127d0, 0x4a)
mineserver  | 	/go/src/mineserver/vendor/app/models/pgsql.go:17 +0x28b
mineserver  | main.main()
mineserver  | 	/go/src/mineserver/main.go:32 +0x16d
mineserver exited with code 2
postgres  | 2018-01-25 06:28:05.360 UTC [1] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432
postgres  | 2018-01-25 06:28:05.360 UTC [1] LOG:  listening on IPv6 address &quot;::&quot;, port 5432
postgres  | 2018-01-25 06:28:05.363 UTC [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;
postgres  | 2018-01-25 06:28:05.449 UTC [20] LOG:  database system was shut down at 2018-01-25 05:48:24 UTC
postgres  | 2018-01-25 06:28:05.475 UTC [1] LOG:  database system is ready to accept connections
</code></pre>
<p>如输出，使用过程中遇到一个问题，<code>mineserver</code>依赖于<code>postgre</code>，导致<code>mineserver</code>无法正常启动。解决方案有：
1 重启minerserver，<code>docker-compose start mineserver</code>
2 改写mineserver链接数据库的部分，增加重试机制
3 分成多个docker-composr.yml，按依赖关系来分先后启动
4 添加依赖关系来控制启动顺序，新增depends_on选项如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#75715e"># docker-compose.yml</span>
...
<span style="color:#f92672">mineserver</span>:
    <span style="color:#ae81ff">... </span>
    <span style="color:#f92672">depends_on</span>:     <span style="color:#75715e"># 依赖关系</span>
      - <span style="color:#ae81ff">postgres</span>
    <span style="color:#f92672">links</span>:          <span style="color:#75715e"># 容器互联</span>
      - <span style="color:#ae81ff">postgres:postgres</span>
</code></pre></div><p>但是，也没有办法知道被依赖的服务是不是启动成功了，所以在必须依赖的时候后还是会有问题
5 参见<a href="https://docs.docker.com/compose/startup-order/">官网解决方案</a>，增加一个<code>wait-for-it.sh</code>。
docker-compose.yml 文件如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#75715e"># docker-compose.yml</span>
...
<span style="color:#f92672">mineserver</span>:
    <span style="color:#ae81ff">... </span>
    <span style="color:#f92672">depends_on</span>:     <span style="color:#75715e"># 依赖关系</span>
      - <span style="color:#ae81ff">postgres</span>
    <span style="color:#f92672">links</span>:          <span style="color:#75715e"># 容器互联</span>
      - <span style="color:#ae81ff">postgres:postgres</span>
    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;./wait-postgres.sh&#34;</span>, <span style="color:#e6db74">&#34;./mineserver&#34;</span>] <span style="color:#75715e"># 结合wait-postgres.sh理解</span>
</code></pre></div><p>wait-postgres.sh 文件如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span><span style="color:#75715e"># wait-postgre.sh</span>

host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;postgres&#34;</span>

<span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>seq <span style="color:#ae81ff">1</span> 10<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">do</span>
  nc -z $host <span style="color:#ae81ff">5432</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $? -eq <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
    echo -n .
    sleep <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">else</span>
    echo <span style="color:#e6db74">&#34;Postgres is ready&#34;</span>
    break
  <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>

<span style="color:#75715e"># execute mineserver, $1 is command that start mineserver</span>
$1

<span style="color:#75715e"># how to use?</span>
<span style="color:#75715e"># command: [&#34;./wait-postgres.sh&#34;, &#34;./imetro-server&#34;]</span>
</code></pre></div><p>关于<strong>5th</strong>，需要注意的要注意<code>wait-for-it.sh</code>, 需要放到服务镜像中去；要根据server镜像中的shell来指定sh，譬如说，我最开始使用的是bash，然而bash在alpine中并不存在……；另外wait-for-it.sh 需要可执行权限哦。</p>
<h3 id="关于docker-composeyml的其他命令">关于docker-compose.yml的其他命令</h3>
<p><a href="https://docs.docker.com/compose/overview/">官方文档</a>或者<a href="https://feisky.xyz/docker/compose/yaml_file.html">Docker入门到实践</a>已经讲的很清楚了</p>


                            
                            
                            
                            
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section>
      <form method="post" action="post-action">
        <div class="fields">
          <div class="field">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" />
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" />
          </div>
          <div class="field">
            <label for="message">Message</label>
            <textarea name="message" id="message" rows="3"></textarea>
          </div>
        </div>
        <ul class="actions">
          <li><input type="submit" value='Send A Message' /></li>
        </ul>
      </form>
    </section>
    
    <section class="split contact">
        
        <section class="alt">
            <h3>Address</h3>
            <p>
                
                     Chengdu · China
                
                     <br/>  This is a city that comes and doesn&#39;t want to go
                
            </p>
        </section>
        
        
        <section>
            <h3>Phone</h3>
            <p><a href="tel:no%20way">no way</a></p>
        </section>
        
        
        <section>
            <h3>Email</h3>
            <p><a href="mailto:yeqown@gmail.com">yeqown@gmail.com</a></p>
        </section>
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/yeqown" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                
                
                
                <li><a href="https://github.com/yeqown" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Yeqown</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
            










<script src='/assets/js/bundle.js'></script>
	</body>
</html>
