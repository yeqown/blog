<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>ä¸€æ¬¡gRPCä½¿ç”¨ä¸å½“å¯¼è‡´goroutineæ³„æ¼æ’æŸ¥è®°å½• &middot; Yeqown</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		<link rel="shortcut icon" href="favicon.ico">
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
		<link rel="stylesheet" href="/highlight/styles/monokai-sublime.css">
		
		<script src="/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Yeqown</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Yeqown</a></li>
        
        <li><a href='/#footer'>Contact</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/yeqown" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        
        
        
        <li><a href="https://github.com/yeqown" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">January 17, 2020</span>
                                
                                <h1>ä¸€æ¬¡gRPCä½¿ç”¨ä¸å½“å¯¼è‡´goroutineæ³„æ¼æ’æŸ¥è®°å½•</h1>
                                <p>ä¸€æ¬¡ä½¿ç”¨pprofå·¥å…·å®šä½å’Œæ’æŸ¥goroutineæ³„æ¼çš„å®æˆ˜è®°å½•ã€‚</p>
                            </header>
                            
                            <blockquote>
<p>ç”±äºä¿ç•™å¿…è¦çš„â€œç½ªè¯â€ï¼Œå› æ­¤æŸäº›å¼‚å¸¸åªèƒ½é€šè¿‡æ–‡å­—æ¥æè¿°äº†ï½</p>
</blockquote>
<h3 id="èƒŒæ™¯">èƒŒæ™¯</h3>
<p>æ˜¨æ™šä¸Š10ç‚¹å·¦å³ï¼Œå‰ç«¯ç«¥é‹åæ˜ å¼€å‘ç¯å¢ƒæ¥å£å“åº”è¶…æ—¶ï¼Œä½†è¿‡äº†å‡ åˆ†é’Ÿååˆæ¢å¤äº†ï¼Œäºæ˜¯æœ‰äº†è¿™ä¸€ç¯‡æ–‡ç« ã€‚</p>
<blockquote>
<p>å…¶å®å¾ˆä¹…ä»¥å‰å°±å‡ºç°äº†å†…å­˜å ç”¨å¼‚å¸¸çš„æƒ…å†µï½ï¼Œåªæ˜¯å ç”¨å¹¶ä¸é«˜ä¹Ÿå°±æ˜¯50MBå·¦å³ï¼ŒåŠ ä¸Šå½“æ—¶è¿˜å¿™ç€å†™ä¸šåŠ¡éœ€æ±‚å°±æ²¡æœ‰æ€¥ç€åŠ ä¸Špprofæ¥æ£€æŸ¥ã€‚</p>
</blockquote>
<p>é¦–å…ˆé€šè¿‡<code>è¿ç»´å¹³å°(k8s based)</code>ç›´è§‚å‘ç°äº†è¯¥podæ•°é‡ä»1å˜æˆäº†2, å†ç»“åˆæ–°å¢podçš„å¯åŠ¨æ—¶é—´ï¼Œæˆ‘å‘ç°è¯¥æ—¶é—´æ­£å¥½æ˜¯å‰ç«¯ç«¥é‹åæ˜ çŠ¶å†µçš„æ—¶é—´èŠ‚ç‚¹ï¼Œç¨åæˆ‘æ£€æŸ¥äº†ä¸‹è¯¥æœåŠ¡çš„èµ„æºé™åˆ¶å¦‚ä¸‹å›¾ï¼š</p>
<img src="/images/pprof-goroutine-leak-1.png"/>
<p>é‚£ä¹ˆå‰ç«¯ç«¥é‹åæ˜ çš„é—®é¢˜å°±å¾ˆæ˜æ˜¾äº†ï¼Œç”±äºæŸç§åŸå› å¯¼è‡´äº†podå†…å­˜è¶…é™ï¼Œè§¦å‘äº†è¿ç»´å¹³å°å¯¹äºå†…å­˜è¶…é™çš„â€œå®¹å¿æœºåˆ¶â€ã€‚è¡¨ç°ä¸º: æ–°å¢ä¸€ä¸ªpodç”¨äºç¼“è§£æœåŠ¡å‹åŠ›ï¼Œè€æœåŠ¡ç”±äºæ— æ³•ç”³è¯·æ›´å¤šå†…å­˜ä¼šå¯¼è‡´å´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ï¼ˆæ— æ³•å“åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼‰ï¼Œè¿™ä¸åæ˜ çš„æƒ…å†µä¸€è‡´ã€‚</p>
<img src="/images/pprof-goroutine-leak-3.png"/>
<h3 id="pprofæ’æŸ¥">pprofæ’æŸ¥</h3>
<p>çŸ¥é“äº†æœåŠ¡å†…å­˜å¼‚å¸¸ï¼Œæƒ³è¦å…·ä½“å®šä½çš„è¯ï¼Œè¿™æ—¶å€™å°±éœ€è¦pprofä¸Šåœºäº†ã€‚</p>
<blockquote>
<p>å¦‚æœä½ éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½å¼€å¯pprofçš„è¯ï¼Œé‚£ä¹ˆåªèƒ½ç­‰å¾…å¤ç°äº†ã€‚è¿™é‡Œæˆ‘åœ¨å¼€å‘ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒä¸€ç›´å¼€å¯äº†pprofï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ£€æŸ¥ã€‚ä¸ªäººè§‰å¾—ï¼Œè¿™æ ·è¿˜å¯ä»¥å¸®åŠ©å¼€å‘å’Œæµ‹è¯•ï¼Œå®Œæˆæœ€åˆçš„æ€§èƒ½åˆ†æğŸ˜¼ã€‚</p>
</blockquote>
<h4 id="å†…å­˜æ£€æŸ¥">å†…å­˜æ£€æŸ¥</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">go tool pprof --http<span style="color:#f92672">=</span>:8080 https://service.host.com/debug/pprof/heap
</code></pre></div><p>è¿™ä¸ªå‘½ä»¤æ˜¯åœ¨æœ¬åœ°æ‰“å¼€ä¸€ä¸ªwebæœåŠ¡ï¼Œç›´æ¥å¯è§†åŒ–è¯¥æœåŠ¡çš„å†…å­˜å ç”¨æƒ…å†µã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨:</p>
<p><code>go tool pprof https://service.host.com/debug/pprof/heap</code> ä½¿ç”¨äº¤äº’æ¨¡å¼æ¥åˆ†æã€‚é€šè¿‡è¿™ä¸ªæ­¥éª¤å®šä½åˆ°äº† grpcç›¸å…³çš„åŒ…å†…å­˜å ç”¨å¼‚å¸¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<pre><code>50MB+ google.golang.org/grpc/internal/transport.newBufWriter
50MB+ bufio.NewReaderSize
http2 ç›¸å…³åº“çš„å ç”¨ä¹Ÿæ¯”è¾ƒå¤š
</code></pre><p>è¿™ä¸€åˆ‡éƒ½æŒ‡å‘äº†æˆ‘ä»¬ä½¿ç”¨çš„gRPCï¼Œå¯æ˜¯ä¸ºå•¥ä½¿ç”¨gRPCä¼šç”¨åˆ°è¿™ä¹ˆâ€œå¤šâ€å†…å­˜å‘¢ï¼Ÿæ¥ç€åˆ†æ</p>
<h4 id="goroutineæ£€æŸ¥">goroutineæ£€æŸ¥</h4>
<p>æ‰“å¼€ä¸€çœ‹ <strong><a href="https://service.host.com/debug/pprof/">https://service.host.com/debug/pprof/</a><strong>ä¸€çœ‹ï¼Œgoroutineå’Œheapå±…â€œé«˜â€(4000+)ä¸ä¸‹ï¼Œè™½ç„¶å¯¹äºåŠ¨è¾„10W+çš„åˆ«äººå®¶çš„æœåŠ¡æ¥è¯´ï¼Œè¿™ç‚¹æ ¹æœ¬ä¸ç®—äº‹ï¼Œä½†åœ¨æˆ‘ä»¬è¿™ç§å°ä½œåŠé‡Œå¯å°±ç®—å¼‚å¸¸äº†ã€‚ç‚¹å¼€çœ‹goroutineæŸ¥çœ‹è¯¦æƒ…ï¼Œæœ‰å››ä¸ªéƒ¨åˆ†çš„goroutineåˆ†åˆ«æœ‰900ä¸ªå·¦å³ï¼Œè¿™é‡Œå°±ç®—åˆæ­¥å®šä½äº†</strong>â€œgRPCå®¢æˆ·ç«¯ä½¿ç”¨äº†è¾ƒå¤šçš„goroutineï¼Œä½†æ˜¯å´æ²¡æœ‰æ­£ç¡®çš„ç»“æŸæ‰â€</strong>ï¼Œå¦‚ä¸‹å›¾ï¼ˆè¿™æ˜¯è§£å†³åçš„æˆªçš„å›¾ï¼‰ï¼š</p>
<img src="/images/pprof-goroutine-leak-2.jpg"/>
<h4 id="pprofæ€»ç»“">pprofæ€»ç»“</h4>
<p>æœåŠ¡ä¸­ä½¿ç”¨çš„gRPCå®¢æˆ·ç«¯å‡ºäº†æŸäº›æ•…éšœï¼Œå¯¼è‡´äº†goroutineæ³„æ¼ï¼Œå¼•å‘äº†OOMï¼ˆOut Of Memoryï¼‰ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<img src="/images/pprof-goroutine-leak-3.png"/>
<h3 id="ä»£ç æ’æŸ¥">ä»£ç æ’æŸ¥</h3>
<p>ä¸Šä¸€æ­¥å·²ç»å®šä½åˆ°æ˜¯gRPCå®¢æˆ·ç«¯çš„é—®é¢˜ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥ä»ä»£ç ä¸Šæ‰‹äº†ã€‚æˆ‘å¿ƒé‡Œå·²ç»æœ‰ä¸€ä¸ªâ€œå«Œç–‘çŠ¯â€äº†ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> (
    <span style="color:#a6e22e">defaultHandler</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">handler</span>
    <span style="color:#a6e22e">timeout</span>        = <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>
    <span style="color:#75715e">// _              pb.UserServiceClient = &amp;handler{}
</span><span style="color:#75715e"></span>)

<span style="color:#75715e">// Init of usersvc.handler
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Init</span>(<span style="color:#a6e22e">rpcAddr</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// ... ç•¥å»ä¸è¡¨
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">handler</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#75715e">// rpc configs
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rpcAddr</span>          <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">client</span>           <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">UserServiceClient</span>
    <span style="color:#a6e22e">lastGrpcReqError</span> <span style="color:#66d9ef">error</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">handler</span>) <span style="color:#a6e22e">connectRPC</span>() {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">client</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">lastGrpcReqError</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// è¿™é‡Œåˆ¤æ–­çš„æœ¬æ„æ˜¯ï¼šå¦‚æœå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æˆ–è€…æœŸé—´å› ä¸ºå¼‚å¸¸æƒ…å†µï¼Œå¯¼è‡´å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥ä¸­æ–­çš„æƒ…å†µä¸‹å°è¯•é‡è¿ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä½†æ˜¯å¿½ç•¥äº†gRPCå®ç°ä¸­ï¼Œå¯¹äºå®¢æˆ·ç«¯çš„å¤„ç†ï¼š
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 1. grpc.Dail æ˜¯å¼‚æ­¥çš„
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2. grpc æœ‰è‡ªå·±çš„é‡è¿æœºåˆ¶
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¿™ä¸€éƒ¨åˆ†æˆ‘è¿˜æ²¡æœ‰çœ‹å®Œï¼Œå°±ä¸ä¹±å‘è¡¨çœ‹æ³•äº†ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">rpcAddr</span>, <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithInsecure</span>())
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;could not dial: %s with err: %v&#34;</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">rpcAddr</span>, <span style="color:#a6e22e">err</span>)
            <span style="color:#66d9ef">return</span>
        }

        <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;usersvc.client.connectRPC called&#34;</span>)
        <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">client</span> = <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">NewUserServiceClient</span>(<span style="color:#a6e22e">conn</span>)
    }
}

<span style="color:#75715e">// QueryBasicInfoByID based default Handler .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">QueryBasicInfoByID</span>(<span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ByIDForm</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BasicInfoResponse</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">defaultHandler</span>.<span style="color:#a6e22e">connectRPC</span>()
    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">timeout</span>)
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()

    <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">defaultHandler</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">QueryBasicInfoByID</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">in</span>)
    <span style="color:#a6e22e">defaultHandler</span>.<span style="color:#a6e22e">lastGrpcReqError</span> = <span style="color:#a6e22e">err</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>æŠ›å¼€æœ¬æ„ä¸è°ˆï¼Œè¿™æ ·çš„å†™æ³•ä¹Ÿæ˜¯ä¸OKçš„ã€‚ã€‚ã€‚å› ä¸º</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">client</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">lastGrpcReqError</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#75715e">// ç»è¿‡åˆå§‹åŒ–åçš„clientå§‹ç»ˆä¸ç­‰äºnil, é‚£ä¹ˆæ§åˆ¶grpc.Dailçš„å°±åªå‰©ä¸‹äº†err, 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è€Œerrçš„å–å€¼æ˜¯æ‰€æœ‰çš„æ–¹æ³•çš„æŠ¥é”™ï¼Œè€Œä¸åªæ˜¯è¿æ¥å¼‚å¸¸ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>}
</code></pre></div><p>é‚£ä¹ˆä¿®å¤å·¥ä½œåªéœ€è¦ <em><strong>å»é™¤æ‰è¿™â€œç®€é™‹ç ´çƒ‚â€çš„é‡è¿</strong></em> å°±è¡Œäº†ï¼š<em><strong>æ³¨é‡Šæ‰æ‰€æœ‰è·ŸconnectRPCå’ŒlastGrpcReqErrorç›¸å…³çš„ä»£ç è¡Œ</strong></em>ã€‚</p>
<p>è¿™é‡Œæˆ‘è¿˜åšäº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">N</span> = <span style="color:#ae81ff">100</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Test_clientErr</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
    <span style="color:#a6e22e">profileWriter</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;./profile.normal.out&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>, <span style="color:#ae81ff">0644</span>)
    <span style="color:#a6e22e">heapWriter</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;./memprofile.normal.out&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>, <span style="color:#ae81ff">0644</span>)
    
    <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">StartCPUProfile</span>(<span style="color:#a6e22e">profileWriter</span>)
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">StopCPUProfile</span>()

    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
        <span style="color:#75715e">// Normal err = nil
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">QueryBasicInfoByID</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">usrpb</span>.<span style="color:#a6e22e">ByIDForm</span>{<span style="color:#a6e22e">UserId</span>: <span style="color:#ae81ff">1</span>}) 
        <span style="color:#75715e">// ä¼šè§¦å‘ err = NotFound
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// resp, err := QueryBasicInfoByID(&amp;usrpb.ByIDForm{UserId: 11})
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span>)
    }

    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">GC</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">WriteHeapProfile</span>(<span style="color:#a6e22e">heapWriter</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
    }
}

<span style="color:#75715e">// æœªä¿®å¤å‰ï¼Œ100ä¸ªNotFoundé”™è¯¯
</span><span style="color:#75715e">// Showing nodes accounting for 8040.19kB, 100% of 8040.19kB total
</span><span style="color:#75715e">// Showing top 10 nodes out of 26
</span><span style="color:#75715e">//       flat  flat%   sum%        cum   cum%
</span><span style="color:#75715e">//  5446.66kB 67.74% 67.74%  5446.66kB 67.74%  google.golang.org/grpc/internal/transport.newBufWriter
</span><span style="color:#75715e">//  1056.33kB 13.14% 80.88%  1056.33kB 13.14%  bufio.NewReaderSize
</span><span style="color:#75715e">//      513kB  6.38% 87.26%      513kB  6.38%  golang.org/x/net/http2/hpack.newInternalNode
</span><span style="color:#75715e">//   512.19kB  6.37% 93.63%   512.19kB  6.37%  runtime.malg
</span><span style="color:#75715e">//   512.01kB  6.37%   100%  1025.01kB 12.75%  golang.org/x/net/http2/hpack.addDecoderNode
</span><span style="color:#75715e">//          0     0%   100%  1025.01kB 12.75%  golang.org/x/net/http2.(*Framer).ReadFrame
</span><span style="color:#75715e">//          0     0%   100%  1025.01kB 12.75%  golang.org/x/net/http2.(*Framer).readMetaFrame
</span><span style="color:#75715e">//          0     0%   100%  1025.01kB 12.75%  golang.org/x/net/http2/hpack.(*Decoder).Write
</span><span style="color:#75715e">//          0     0%   100%  1025.01kB 12.75%  golang.org/x/net/http2/hpack.(*Decoder).parseFieldLiteral
</span><span style="color:#75715e">//          0     0%   100%  1025.01kB 12.75%  golang.org/x/net/http2/hpack.(*Decoder).parseHeaderFieldRepr
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// æœªä¿®å¤å‰ 100 normal
</span><span style="color:#75715e">// Showing nodes accounting for 2208.36kB, 100% of 2208.36kB total
</span><span style="color:#75715e">// Showing top 10 nodes out of 19
</span><span style="color:#75715e">//       flat  flat%   sum%        cum   cum%
</span><span style="color:#75715e">//  1184.27kB 53.63% 53.63%  1184.27kB 53.63%  runtime/pprof.StartCPUProfile
</span><span style="color:#75715e">//   512.08kB 23.19% 76.82%   512.08kB 23.19%  golang.org/x/net/http2.init
</span><span style="color:#75715e">//   512.01kB 23.18%   100%   512.01kB 23.18%  golang.org/x/net/http2/hpack.addDecoderNode
</span><span style="color:#75715e">//          0     0%   100%  1184.27kB 53.63%  git.class100.com/backend/protobuf/benchmark_test.Test_CallUsergRPC_Normal
</span><span style="color:#75715e">//          0     0%   100%   512.01kB 23.18%  golang.org/x/net/http2.(*Framer).ReadFrame
</span><span style="color:#75715e">//          0     0%   100%   512.01kB 23.18%  golang.org/x/net/http2.(*Framer).readMetaFrame
</span><span style="color:#75715e">//          0     0%   100%   512.01kB 23.18%  golang.org/x/net/http2/hpack.(*Decoder).Write
</span><span style="color:#75715e">//          0     0%   100%   512.01kB 23.18%  golang.org/x/net/http2/hpack.(*Decoder).parseFieldLiteral
</span><span style="color:#75715e">//          0     0%   100%   512.01kB 23.18%  golang.org/x/net/http2/hpack.(*Decoder).parseHeaderFieldRepr
</span><span style="color:#75715e">//          0     0%   100%   512.01kB 23.18%  golang.org/x/net/http2/hpack.(*Decoder).readString
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// ä¿®å¤åï¼Œ100ä¸ªNotFoundé”™è¯¯
</span><span style="color:#75715e">// Showing nodes accounting for 1537.02kB, 100% of 1537.02kB total
</span><span style="color:#75715e">// Showing top 10 nodes out of 14
</span><span style="color:#75715e">//       flat  flat%   sum%        cum   cum%
</span><span style="color:#75715e">//  1024.02kB 66.62% 66.62%  1537.02kB   100%  golang.org/x/net/http2/hpack.addDecoderNode
</span><span style="color:#75715e">//      513kB 33.38%   100%      513kB 33.38%  golang.org/x/net/http2/hpack.newInternalNode
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2.(*Framer).ReadFrame
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2.(*Framer).readMetaFrame
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2/hpack.(*Decoder).Write
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2/hpack.(*Decoder).parseFieldLiteral
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2/hpack.(*Decoder).parseHeaderFieldRepr
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2/hpack.(*Decoder).readString
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2/hpack.buildRootHuffmanNode
</span><span style="color:#75715e">//          0     0%   100%  1537.02kB   100%  golang.org/x/net/http2/hpack.getRootHuffmanNode
</span></code></pre></div><p>åªæ˜¯100ä¸ªé”™è¯¯çš„è§¦å‘å°±èƒ½çœ‹è§å†…å­˜å ç”¨æœ‰æ˜æ˜¾çš„ä¸Šå‡ï¼Œä¿®å¤ç‰ˆæœ¬çš„å†…å­˜å ç”¨ä¹Ÿæ˜¾è‘—ä¸‹é™äº†ã€‚é‡æ–°éƒ¨ç½²æœåŠ¡åï¼Œé€šè¿‡æ£€æŸ¥pprofï¼Œå¦‚ä¸‹å›¾ï¼šgoroutineæ•°é‡ä¹Ÿæ­£å¸¸(4000+ =&gt; 68)äº†ã€‚</p>
<p><img src="/images/pprof-goroutine-leak-5.png" /></p>
<p>ä»å†…å­˜å ç”¨ä¸Šçœ‹ï¼Œä¹Ÿä¸€ç›´å¤„äºæ­£å¸¸çš„èŒƒå›´ï¼ˆå½“ç„¶è¿˜éœ€è¦é•¿æœŸè§‚å¯Ÿï¼‰ï¼š</p>
<p><img src="/images/pprof-goroutine-leak-6.png" /></p>
<h4 id="ä»£ç åˆ†ææ€»ç»“">ä»£ç åˆ†ææ€»ç»“</h4>
<p>è¯¥é—®é¢˜ä¸€ç›´å­˜åœ¨è¯¥æœåŠ¡ä¸­ï¼Œç”šè‡³å½±å“åˆ°äº†å…¶ä¸Šæ¸¸æœåŠ¡ï¼Œä½†æ˜¯ç”±äºç§ç§åŸå› ï¼š</p>
<pre><code>1. è¿­ä»£è¾ƒå¿«ï¼ŒæœåŠ¡æ›´æ–°é¢‘ç¹
2. lastGrpcReqErrorè§¦å‘å¹¶ä¸é¢‘ç¹
3. å†…å­˜è¶…é™è®¾ç½®è¾ƒé«˜ï¼Œæ²¡æœ‰è§¦å‘æŠ¥è­¦
4. ä¸šåŠ¡é©±åŠ¨ã€‚ã€‚ã€‚ORZ
</code></pre>
<p>ä¸€ç›´å¾—è¿‡ä¸”è¿‡ï¼Œæ²¡æœ‰å½±å“ä¸šåŠ¡ä¹Ÿå°±æ— æ‰€è°“äº†ï¼Œæƒ³èµ·æ¥ä¸€å¥è¯ï¼Œâ€œæˆ‘ä»¬è¿™ä½“é‡ï¼Œä¸è¦è¿‡æ—©ä¼˜åŒ–æµªè´¹æ—¶é—´ï¼Œå…ˆæŠŠéœ€æ±‚å®ç°å’¯â€ã€‚ä¸è¿‡æˆ‘è§‰çš„æ’æŸ¥è¿™ç§é—®é¢˜è¿˜æ˜¯å¾ˆæœ‰è¶£çš„ï¼Œè‡³å°‘æ¯”å†™ä¸šåŠ¡æœ‰è¶£ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<ol start="0">
<li>ğŸ˜‚pprofæˆ‘ç”¨å¾—ä¹Ÿä¸å¤Ÿç†Ÿç»ƒï¼Œè¿™é‡Œå§‘ä¸”ç®—æ˜¯ä¸€æ¬¡å®è·µäº†</li>
<li>ğŸ˜‚ä¿ç•™æ›´å¤šçš„ç½ªè¯ï¼Œæ–¹ä¾¿æ°´ä¸€ç¯‡æ–‡ç« ï¼Œé¿å…â€œå£è¯´æ— å‡­â€ï¼ˆé‚£æˆ‘ä¹Ÿæƒ³ä¸åˆ°ï¼Œæˆ‘ä¼šå†™è¿™ç§æ–‡ç« å•Šï¼‰</li>
<li>ğŸ˜‚ç›‘æ§æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä¸€å®šè¦ç›‘æ§å¥½ä½ çš„æœåŠ¡ï¼Œå¹¶åŠæ—¶å‘Šè­¦</li>
<li>ğŸ˜‚pprof ä¹Ÿæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œæ—©ç‚¹åŸ‹è¿›ä½ çš„æœåŠ¡é‡Œï¼Œé¿å…åˆ°äº†è¦åˆ†æçš„æ—¶å€™å´æ²¡æœ‰æ•°æ®å¯ç”¨äºåˆ†æ</li>
<li>ğŸ˜‚7ä¸ªæœˆå¤ªé•¿äº†ï¼Œä»¥è‡³äºæˆ‘éƒ½ä¸æƒ³æ‰¿è®¤è¿™æ˜¯æˆ‘å†™çš„</li>
<li>ğŸ˜‚è¿™é‡Œæ²¡æœ‰å»åˆ†ægRPCçš„å®ç°ç»†èŠ‚ï¼Œå› ä¸ºæˆ‘è¿˜æ²¡æœ‰å¼€å§‹çœ‹ã€‚ã€‚ã€‚å…ˆç•™ä¸ªå‘å§</li>
</ol>


                            
                            
                            
                            
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section>
      <form method="post" action="post-action">
        <div class="fields">
          <div class="field">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" />
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" />
          </div>
          <div class="field">
            <label for="message">Message</label>
            <textarea name="message" id="message" rows="3"></textarea>
          </div>
        </div>
        <ul class="actions">
          <li><input type="submit" value='Send A Message' /></li>
        </ul>
      </form>
    </section>
    
    <section class="split contact">
        
        <section class="alt">
            <h3>Address</h3>
            <p>
                
                     Chengdu Â· China
                
                     <br/>  This is a city that comes and doesn&#39;t want to go
                
            </p>
        </section>
        
        
        <section>
            <h3>Phone</h3>
            <p><a href="tel:no%20way">no way</a></p>
        </section>
        
        
        <section>
            <h3>Email</h3>
            <p><a href="mailto:yeqown@gmail.com">yeqown@gmail.com</a></p>
        </section>
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/yeqown" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                
                
                
                <li><a href="https://github.com/yeqown" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Yeqown</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
            










<script src='/assets/js/bundle.js'></script>
	</body>
</html>
