<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>SSH Tunnelå°å·¥å…· &middot; Yeqown</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		<link rel="shortcut icon" href="favicon.ico">
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
		<link rel="stylesheet" href="/highlight/styles/monokai-sublime.css">
		
		<script src="/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Yeqown</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Yeqown</a></li>
        
        <li><a href='/#footer'>Contact</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/yeqown" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        
        
        
        <li><a href="https://github.com/yeqown" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">January 8, 2020</span>
                                
                                <h1>SSH Tunnelå°å·¥å…·</h1>
                                <p>ç†è§£éš§é“åŸç†ï¼Œé€ ä¸€ä¸ªéš§é“å°å·¥å…·å¸®åŠ©æé«˜å¼€å‘æ•ˆç‡ã€‚</p>
                            </header>
                            
                            <h3 id="èƒŒæ™¯">èƒŒæ™¯</h3>
<p>ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¸å…è®¸ç›´æ¥è®¿é—®ï¼Œä½†æ˜¯åˆç»å¸¸æœ‰éœ€è¦ç›´æ¥æ“ä½œæ•°æ®åº“çš„éœ€æ±‚ğŸ˜‚ã€‚å…ˆä¸è¯´åˆä¸åˆç†ï¼ŒèƒŒæ™¯å°±æ˜¯è¿™ä¸ªèƒŒæ™¯ï¼Œå› æ­¤åªèƒ½é€šè¿‡è·³æ¿æœºæ¥è¿æ¥æ•°æ®åº“ï¼Œä¸€ï¼ˆå°±ï¼‰èˆ¬ï¼ˆæˆ‘ï¼‰æ¥ï¼ˆè€Œï¼‰è¯´ï¼ˆè¨€ï¼‰ä¼šä½¿ç”¨sshéš§é“ï¼Œå°±è½»æ¾èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç„¶é¹…ï¼Œäº‹æƒ…å¹¶ä¸ç®€å•ã€‚è¿™é‡Œé™ˆè¿°ä¸€ä¸‹ï¼š</p>
<ol>
<li>ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¸è®©ç›´æ¥è®¿é—®ï¼›</li>
<li>è·³æ¿æœºä¸Šæ²¡æœ‰å…¬é’¥ï¼Œæ²¡æœ‰æƒé™ï¼›</li>
<li>æˆ‘ä¸€æ¬¡å¯èƒ½éœ€è¦å¼€3+ä¸ªéš§é“æ‰èƒ½å¯åŠ¨æœåŠ¡ã€æ•²é‡ç‚¹ã€‘</li>
</ol>
<h3 id="è§£å†³">è§£å†³</h3>
<p>æœ¬ç€â€œæˆ‘ä¸é€ è½®å­ï¼Œè°æ¥é€ è½®å­â€çš„æƒ³æ³•ï¼Œè¿™é‡Œå°±é€ ä¸€ä¸ªå°è½®å­ï¼šç”¨<code>Go</code>æ¥å®ç°SSHéš§é“å¤šå¼€ï¼Œå¹¶æ”¯æŒé…ç½®ã€‚æˆæœé¢„è§ˆï¼š
<img src="/images/ssh-tunnel-helper.jpg"/>
<img src="/images/ssh-tunnel-helper-usage.jpg"/></p>
<h4 id="åŸç†ç®€è¦åˆ†æ">åŸç†ç®€è¦åˆ†æ</h4>
<p>å¦‚æœä»£ç†åŸç†æœ‰ç‚¹äº†è§£ï¼Œè¿™é‡Œçš„åŸç†å·®ä¸å¤šæ˜¯ä¸€æ ·çš„ï¼šLocal &lt;-&gt; SSH tunnel &lt;-&gt; Remote Serverï¼Œå¯¹äºéš§é“æ¥è¯´æŠŠLocalçš„è¯·æ±‚ä¼ ç»™Remote, æŠŠRemoteçš„å“åº”å‘Šè¯‰Localã€‚ç›´æ¥ä¸Šä»£ç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Start .
</span><span style="color:#75715e">// TODO: support random port by using localhost:0
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tunnel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SSHTunnel</span>) <span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">LocalAddr</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Close</span>()
    <span style="color:#75715e">// tunnel.Local.Port = listener.Addr().(*net.TCPAddr).Port
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> {
        <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">name</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; accepted connection&#34;</span>)
        <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">forward</span>(<span style="color:#a6e22e">conn</span>)
    }
}

<span style="color:#75715e">// åˆ›å»ºéš§é“å¹¶ä¼ é€’æ¶ˆæ¯ï¼Œåˆ†åˆ«æœ‰ä¸¤ä¸ªç«¯ç‚¹ï¼Œä¸€ä¸ªæ˜¯æœ¬åœ°éš§é“å£ï¼Œå¦ä¸€ä¸ªæ˜¯è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„éš§é“å£
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tunnel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SSHTunnel</span>) <span style="color:#a6e22e">forward</span>(<span style="color:#a6e22e">localConn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
    <span style="color:#75715e">// åˆ›å»ºæœ¬åœ°åˆ°è·³æ¿æœºçš„SSHè¿æ¥
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">serverSSHClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ssh</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">ServerAddr</span>, <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">SSHConfig</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">name</span>()<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; server dial error: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span>
    }
    <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">name</span>()<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; connected to server=%s (1 of 2)&#34;</span>, <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">ServerAddr</span>)
    <span style="color:#75715e">// åˆ›å»ºè·³æ¿æœºåˆ°è¿œç¨‹æœåŠ¡å™¨çš„è¿æ¥
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">remoteConn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serverSSHClient</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">RemoteAddr</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">name</span>()<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; remote dial error: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span>
    }
    <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">name</span>()<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; connected to remote=%s (2 of 2)&#34;</span>, <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">RemoteAddr</span>)

    <span style="color:#a6e22e">copyConn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">writer</span>, <span style="color:#a6e22e">reader</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
        <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">writer</span>, <span style="color:#a6e22e">reader</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">name</span>()<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; io.Copy error: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
    }

    <span style="color:#75715e">// local(w) =&gt; è¿œç¨‹(r)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">copyConn</span>(<span style="color:#a6e22e">localConn</span>, <span style="color:#a6e22e">remoteConn</span>)
    <span style="color:#75715e">// è¿œç¨‹(w) =&gt; æœ¬åœ°(r)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">copyConn</span>(<span style="color:#a6e22e">remoteConn</span>, <span style="color:#a6e22e">localConn</span>)
}
</code></pre></div><p>ä»£ç ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">forward</span>() {
    <span style="color:#75715e">// ... some code ignored
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä¸‹é¢çš„ä»£ç å®ç°äº†æ¶ˆæ¯ä¼ é€’ï¼Œé—®é¢˜ï¼šä¸ºä»€ä¹ˆ`io.Copy + net.Conn`å°±å¯ä»¥å®ç°æ•°æ®çš„æŒç»­ä¼ é€’å‘¢ï¼Ÿ
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">copyConn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">writer</span>, <span style="color:#a6e22e">reader</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
        <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">writer</span>, <span style="color:#a6e22e">reader</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">name</span>()<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; io.Copy error: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
    }

    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">copyConn</span>(<span style="color:#a6e22e">localConn</span>, <span style="color:#a6e22e">remoteConn</span>)
    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">copyConn</span>(<span style="color:#a6e22e">remoteConn</span>, <span style="color:#a6e22e">localConn</span>)
}
</code></pre></div><h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä¸Šè¿°åœºæ™¯ä¹Ÿå¯ä»¥é€šè¿‡å†™è„šæœ¬çš„æ–¹å¼æ¥è§£å†³ï¼Œä½†æ¯•ç«Ÿæ¯ä¸ªå¹³å°å¯¹shellæ”¯æŒå¹¶ä¸ä¸€è‡´ï¼Œè¿˜éœ€è¦å®‰è£…<code>ssh</code>å·¥å…·ï¼Œå› æ­¤è¿˜æ˜¯é€‰æ‹©äº†é€ è½®å­ã€‚</p>
<blockquote>
<p>io.Copyä¼šä¸€ç›´å¤åˆ¶ç›´åˆ°è¯»åˆ°EOFï¼›TCPåè®®åªæœ‰åœ¨å¤„ç†<code>FIN</code>æŠ¥æ–‡æ‰ä¼šå†™å…¥EOFï¼Œå› æ­¤io.Copyä¼šæŒç»­ä¸æ–­çš„åœ¨localå’Œremoteä¹‹é—´å¤åˆ¶æ•°æ®ã€‚</p>
</blockquote>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li><a href="https://medium.com/@elliotchance/how-to-create-an-ssh-tunnel-in-go-b63722d682aa">https://medium.com/@elliotchance/how-to-create-an-ssh-tunnel-in-go-b63722d682aa</a></li>
<li><a href="https://golang.org/x/crypto/ssh">https://golang.org/x/crypto/ssh</a></li>
<li>å¦‚ä½•åœ¨shellè„šæœ¬ä¸­å®ç°äº¤äº’ï¼Œè¯·è‡ªè¡Œgoogle</li>
<li>æ‰€æœ‰çš„ä»£ç å‡åœ¨ï¼šhttps://github.com/yeqown/infrastructure/tree/master/cmd/tunnel-helper</li>
</ul>


                            
                            
                            
                            
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section>
      <form method="post" action="post-action">
        <div class="fields">
          <div class="field">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" />
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" />
          </div>
          <div class="field">
            <label for="message">Message</label>
            <textarea name="message" id="message" rows="3"></textarea>
          </div>
        </div>
        <ul class="actions">
          <li><input type="submit" value='Send A Message' /></li>
        </ul>
      </form>
    </section>
    
    <section class="split contact">
        
        <section class="alt">
            <h3>Address</h3>
            <p>
                
                     Chengdu Â· China
                
                     <br/>  This is a city that comes and doesn&#39;t want to go
                
            </p>
        </section>
        
        
        <section>
            <h3>Phone</h3>
            <p><a href="tel:no%20way">no way</a></p>
        </section>
        
        
        <section>
            <h3>Email</h3>
            <p><a href="mailto:yeqown@gmail.com">yeqown@gmail.com</a></p>
        </section>
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/yeqown" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                
                
                
                <li><a href="https://github.com/yeqown" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Yeqown</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
            










<script src='/assets/js/bundle.js'></script>
	</body>
</html>
