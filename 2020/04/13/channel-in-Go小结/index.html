<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>Channel in Goå°ç»“ &middot; Yeqown</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		<link rel="shortcut icon" href="favicon.ico">
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
		<link rel="stylesheet" href="/highlight/styles/monokai-sublime.css">
		
		<script src="/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Yeqown</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Yeqown</a></li>
        
        <li><a href='/#footer'>Contact</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/yeqown" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        
        
        
        <li><a href="https://github.com/yeqown" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">April 13, 2020</span>
                                
                                <h1>Channel in Goå°ç»“</h1>
                                <p>channelæ˜¯GoåŒºåˆ«äºå…¶ä»–è¯­è¨€çš„ä¸€å¤§ç‰¹è‰²ï¼Œè®©ç¨‹åºå‘˜ä»¬åœ¨goroutineçš„å¹¶å‘åŸºç¡€ä¸Šï¼Œé‡‡ç”¨ç®€å•æ˜“ç†è§£çš„é€šä¿¡æ‰‹æ®µ</p>
                            </header>
                            
                            <p>åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¦‚æœæƒ³è¦åœ¨çº¿ç¨‹ä¸­é€šä¿¡ï¼Œæœ€å¸¸ç”¨çš„æ‰‹æ®µæ˜¯å…±äº«å†…å­˜ã€‚ç„¶è€Œè€ƒè™‘åˆ°çº¿ç¨‹å†²çªé—®é¢˜ï¼Œä¸å¾—ä¸è€ƒè™‘åŠ é”ï¼Œä»¥ä¿è¯å¹¶å‘å®‰å…¨ï¼ŒåŠ é”ä¹Ÿä¸€å®šä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ã€‚</p>
<h3 id="cspæ¨¡å‹">CSPæ¨¡å‹</h3>
<blockquote>
<p>åœ¨ Go è¯­è¨€ä¸­ä¹Ÿèƒ½ä½¿ç”¨å…±äº«å†…å­˜åŠ äº’æ–¥é”è¿›è¡Œé€šä¿¡ï¼Œä½†æ˜¯ Go è¯­è¨€æä¾›äº†ä¸€ç§ä¸åŒçš„å¹¶å‘æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯é€šä¿¡é¡ºåºè¿›ç¨‹ï¼ˆCommunicating sequential processesï¼ŒCSPï¼‰1ã€‚Goroutine å’Œ Channel åˆ†åˆ«å¯¹åº” CSP ä¸­çš„å®ä½“å’Œä¼ é€’ä¿¡æ¯çš„åª’ä»‹ï¼ŒGo è¯­è¨€ä¸­çš„ Goroutine ä¼šé€šè¿‡ Channel ä¼ é€’æ•°æ®ã€‚</p>
</blockquote>
<h3 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</h3>
<p>åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œéœ€è¦å¯¹channelæœ‰ä¸ªæ•´ä½“çš„å°è±¡ï¼š</p>
<ul>
<li>FIFO (First In First Out)</li>
<li>åˆ†ä¸ºæœ‰ç¼“å†²å’Œæ— ç¼“å†²ä¸¤ç§</li>
<li>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šé˜»å¡ï¼ˆæ— ç¼“å†²æ—¶ï¼Œåªæ“ä½œè¯»æˆ–å†™ï¼›æœ‰ç¼“å†²å·²æ»¡æ—¶ï¼Œåªæ“ä½œè¯»æˆ–è€…å†™ï¼‰</li>
<li>æ¥å—è€…å’Œå‘é€è€…éƒ½æ˜¯goroutine</li>
</ul>
<p>å‚è€ƒä¸‹å›¾ï¼š</p>
<image src="/images/channel-overview.svg"/>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// Q: æœ‰ç¼“å†²å’Œæ— ç¼“å†²åœ¨ä½¿ç”¨ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ch := make(chan int) // æ— ç¼“å†²
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// æœ‰ç¼“å†²ï¼Œå¤§å°ä¸º1
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// å‘é€
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>

    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>)
}
</code></pre></div><h4 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h4>
<p>åœ¨ä½¿ç”¨channelæ—¶ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹äº‹é¡¹ï¼š</p>
<table>
<thead>
<tr>
<th>æ“ä½œ\CHçŠ¶æ€</th>
<th>chä¸ºç©º</th>
<th>chå·²å…³é—­</th>
<th>chæ­£å¸¸</th>
</tr>
</thead>
<tbody>
<tr>
<td>å‘é€ ch &lt;-</td>
<td>æ­»é”</td>
<td>panic</td>
<td>æˆåŠŸæˆ–é˜»å¡</td>
</tr>
<tr>
<td>æ¥æ”¶ &lt;-ch</td>
<td>æ­»é”</td>
<td>æˆåŠŸæˆ–ç©ºå€¼</td>
<td>æˆåŠŸæˆ–é˜»å¡</td>
</tr>
<tr>
<td>å…³é—­ close(ch)</td>
<td>panic</td>
<td>panic</td>
<td>æˆåŠŸ</td>
</tr>
</tbody>
</table>
<p>Q: è¿™é‡Œè€ƒè™‘ä¸‹å¦‚ä½•ä¼˜é›…çš„å…³é—­channel (é¿å…panic)?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// A: ä»£ç ä¸Šä»å‘é€ç«¯æ§åˆ¶channelçš„å…³é—­ï¼ŒåŒæ—¶ä¸ºäº†é¿å…é‡å¤å…³é—­ï¼Œä½¿ç”¨sync.Onceæ¥ååŠ©ã€‚
</span><span style="color:#75715e">// create
</span><span style="color:#75715e"></span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">233</span>)
<span style="color:#75715e">// sending
</span><span style="color:#75715e"></span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
<span style="color:#75715e">// close from sender
</span><span style="color:#75715e"></span><span style="color:#a6e22e">once</span>.<span style="color:#a6e22e">Do</span>(close(<span style="color:#a6e22e">ch</span>))
</code></pre></div><h3 id="make-è¯¦è§£">Make è¯¦è§£</h3>
<p>channelé€šè¿‡makeå…³é”®å­—åˆ›å»ºï¼Œå¹¶åˆ†é…ç¼“å†²åŒºå¤§å°ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// runtime/chan.go#makechan
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makechan</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chantype</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span> {
	<span style="color:#a6e22e">elem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">elem</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// elem.size * size æ˜¯å¦æº¢å‡º
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mem</span>, <span style="color:#a6e22e">overflow</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">MulUintptr</span>(<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, uintptr(<span style="color:#a6e22e">size</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">overflow</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">mem</span> &gt; <span style="color:#a6e22e">maxAlloc</span><span style="color:#f92672">-</span><span style="color:#a6e22e">hchanSize</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">size</span> &lt; <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;makechan: size out of range&#34;</span>))
	}

	<span style="color:#75715e">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// buf points into the same allocation, elemtype is persistent.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// SudoG&#39;s are referenced from their owning thread so they can&#39;t be collected.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¤§æ„æ˜¯æ˜¯è¯´ï¼Œå½“å­˜å‚¨åœ¨bufçš„å…ƒç´ ä¸­ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼Œgcå¯¹æ­¤ä¸æ„Ÿå…´è¶£ï¼Ÿï¼ˆç•™å‘ï¼‰å› æ­¤æ‰ä¼šå°†bufå’Œhchanåˆ†é…åœ¨åŒä¸€ç‰‡å†…å­˜ç©ºé—´ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>
	<span style="color:#66d9ef">switch</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">mem</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
		<span style="color:#75715e">// æ— ç¼“å†²ï¼ˆåªåˆ†é…hchanï¼‰
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">raceaddr</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">ptrdata</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
		<span style="color:#75715e">// ä¸å«æŒ‡é’ˆï¼ˆhchanå’Œç¼“å†²åŒºåœ¨ä¸€èµ·ï¼‰
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span><span style="color:#f92672">+</span><span style="color:#a6e22e">mem</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
        <span style="color:#75715e">// bufçš„èµ·å§‹åœ°å€ = åŸºåœ°å€ + hchanç»“æ„ä½“å¤§å°åç§»é‡
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>), <span style="color:#a6e22e">hchanSize</span>)
	<span style="color:#66d9ef">default</span>:
		<span style="color:#75715e">// æœ‰ç¼“å†²ï¼Œå«æŒ‡é’ˆï¼ˆhchanå’Œç¼“å†²åŒºä¸åœ¨ä¸€èµ·ï¼‰
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = new(<span style="color:#a6e22e">hchan</span>)
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">mem</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">true</span>)
	}

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemsize</span> = uint16(<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span> = <span style="color:#a6e22e">elem</span>
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> = uint(<span style="color:#a6e22e">size</span>)
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}
</code></pre></div><h3 id="close-è¯¦è§£">Close è¯¦è§£</h3>
<p><code>close(ch)</code> å¯ä»¥å…³é—­channelã€‚å·²ç»å…³é—­çš„channelä¸å¯ä»¥å‘é€ï¼Œä¹Ÿä¸èƒ½å†è¢«å…³é—­ï¼Œä½†æ˜¯è¿˜èƒ½æ¥æ”¶ã€‚å¦‚æœç¼“å†²æ•°æ®è¢«å¤„ç†å®Œé‚£ä¹ˆä¼šæ¥å—åˆ°ç©ºå€¼ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// runtime/chan.go#closechan
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">closechan</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// å¦‚æœchannelä¸ºç©ºï¼Œåˆ™ä¼šè§¦å‘panic
</span><span style="color:#75715e"></span>		panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;close of nil channel&#34;</span>))
	}

	<span style="color:#a6e22e">lock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#75715e">// å…³é—­å·²ç»å…³é—­çš„channelï¼Œä¹Ÿä¼šè§¦å‘panic
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
		panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;close of closed channel&#34;</span>))
	}

	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// è®¾ç½®å·²å…³é—­æ ‡å¿—ä½
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> = <span style="color:#ae81ff">1</span>

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">glist</span> <span style="color:#a6e22e">gList</span>

	<span style="color:#75715e">// é‡Šæ”¾æ‰€æœ‰çš„recvqä¸­çš„g
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">sg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">dequeue</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">// æ¸…ç©ºæ•°æ®
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">typedmemclr</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span>)
			<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#66d9ef">nil</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#a6e22e">cputicks</span>()
		}
		<span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>
		<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
		<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">glist</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">gp</span>)
	}

	<span style="color:#75715e">// é‡Šæ”¾æ‰€æœ‰çš„sendqä¸­çš„g
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">// ... ä¸æ¥å—è€…å¤„ç†ç±»ä¼¼
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)

	<span style="color:#75715e">// è®©æ‰€æœ‰çš„è¯»/å†™gå°±ç»ª
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> !<span style="color:#a6e22e">glist</span>.<span style="color:#a6e22e">empty</span>() {
		<span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">glist</span>.<span style="color:#a6e22e">pop</span>()
		<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">schedlink</span> = <span style="color:#ae81ff">0</span>
		<span style="color:#a6e22e">goready</span>(<span style="color:#a6e22e">gp</span>, <span style="color:#ae81ff">3</span>)
	}
}
</code></pre></div><h3 id="send-è¯¦è§£">Send è¯¦è§£</h3>
<p>å‘channelå‘é€æœ€å¸¸è§çš„å°±æ˜¯å¦‚ä¸‹2ç§æ–¹å¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// case 1
</span><span style="color:#75715e"></span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">val</span>

<span style="color:#75715e">// case 2 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2</span>:
        <span style="color:#75715e">// foo
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">default</span>:
        <span style="color:#75715e">// bar
</span><span style="color:#75715e"></span>}
</code></pre></div><p>åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šè¢«å˜æˆæˆè°ƒç”¨<code>func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool</code>çš„å‡½æ•°ï¼Œä½†æ˜¯ä¸¤è€…åœ¨å¯¹blockçš„èµ‹å€¼ä¸Šå¹¶ä¸ç›¸åŒï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// case 1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chansend1</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) {
	<span style="color:#a6e22e">chansend</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">getcallerpc</span>())
}

<span style="color:#75715e">// case 2
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectnbsend</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) (<span style="color:#a6e22e">selected</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">chansend</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">getcallerpc</span>())
}
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´åœ¨case2ä¸­ï¼Œchannelå‘é€å¹¶ä¸ä¼šé˜»å¡å½“å‰çš„goroutineï¼Œå°±ç®—æ˜¯æ— ç¼“å†²ï¼Œæˆ–è€…ç¼“å†²å·²æ»¡çš„æƒ…å†µã€‚</p>
<p>å‘é€æœŸé—´å¤„ç†æµç¨‹ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<image src="/images/channel-send.svg"/>
<h3 id="recv-è¯¦è§£">Recv è¯¦è§£</h3>
<p>ä»channelä¸­æ¥æ”¶æ•°æ®ï¼Œä¹Ÿæœ‰ä¸¤ç§æ–¹å¼ (æ™®é€šç”¨æ³•å’Œéé˜»å¡ç”¨æ³•)ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// case 1
</span><span style="color:#75715e"></span><span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span>

<span style="color:#75715e">// case 2 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span>:
        <span style="color:#75715e">// foo
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">default</span>:
        <span style="color:#75715e">// bar
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// æ­¤å¤–æ¥æ”¶ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå‚æ•°ï¼Œokè¡¨ç¤ºå·²æ¥æ”¶
</span><span style="color:#75715e"></span><span style="color:#a6e22e">val</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span>
</code></pre></div><p>åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šè¢«å˜æˆæˆè°ƒç”¨<code>func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool)</code>çš„å‡½æ•°ï¼ŒåŒæ ·çš„ä¸¤è€…åœ¨å¯¹blockçš„èµ‹å€¼ä¸Šå¹¶ä¸ç›¸åŒï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// case 1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chanrecv1</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) {
	<span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">true</span>)
}
<span style="color:#75715e">// å¤šè¿”å›å€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">chanrecv2</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) (<span style="color:#a6e22e">received</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">received</span> = <span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">true</span>)
	<span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">// case 2
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectnbrecv</span>(<span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>) (<span style="color:#a6e22e">selected</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#a6e22e">selected</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">false</span>)
	<span style="color:#66d9ef">return</span>
}
<span style="color:#75715e">// å¤šè¿”å›å€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectnbrecv2</span>(<span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">received</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>) (<span style="color:#a6e22e">selected</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#75715e">// TODO(khr): just return 2 values from this function, now that it is in Go.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">selected</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">received</span> = <span style="color:#a6e22e">chanrecv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">false</span>)
	<span style="color:#66d9ef">return</span>
}
</code></pre></div><p>ç›¸è¾ƒäºsendåœºæ™¯ï¼Œrecvåœºæ™¯ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯å¤§ä½“æµç¨‹ä¸Šä¿æŒä¸€è‡´ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<image src="/images/channel-recv.svg"/>
<p>ç®€å•æ€»ç»“çš„è¯´ï¼Œå°±æ˜¯recvä¸ºäº†å®ç°åœ¨<code>å‘é€è€…é˜»å¡</code>çš„åœºæ™¯ä¸‹çš„FIFOï¼Œåšäº†ç‰¹æ®Šå¤„ç†ã€‚</p>
<h3 id="ä½¿ç”¨åœºæ™¯å’Œæ¨¡å¼">ä½¿ç”¨åœºæ™¯å’Œæ¨¡å¼</h3>
<p>ä¸‹é¢åˆ—ä¸¾äº†ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„channelä½¿ç”¨æ¨¡å¼åŠç›¸å…³åœºæ™¯ã€‚è¿™é‡Œä¸»è¦å‚è€ƒäº†<a href="https://chai2010.cn/advanced-go-programming-book/ch1-basic/ch1-06-goroutine.html">advanced-go-programming-book</a>ã€‚</p>
<blockquote>
<p>å¦‚æœ‰é—æ¼ï¼Œæ•¬è¯·è¡¥å……</p>
</blockquote>
<h4 id="synchronous">Synchronous</h4>
<p>ä¸€èˆ¬æ¥è¯´åœ¨éœ€è¦åŒæ­¥goroutineçš„åœºæ™¯ä¸‹ï¼Œä¼šä½¿ç”¨sync.Mutexæˆ–è€…sync.WaitGroupæ¥åŒæ­¥ã€‚è¿™é‡Œç”¨channelæ¥å®ç°ä¸€ä¸‹goroutineåŒæ­¥ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">1</span>)

    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(){
        println(<span style="color:#e6db74">&#34;i&#39;m running&#34;</span>)
        <span style="color:#a6e22e">done</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
    }()

    <span style="color:#75715e">// å¦‚æœæœ‰å¤šä¸ªgoroutine, å¯ä»¥å¯¹doneæ¥æ”¶è®¡æ•°ï¼Œæˆ–è€…æ£€æµ‹goroutineå…³é—­æ¥åˆ¤æ–­åŒæ­¥å®Œæˆ
</span><span style="color:#75715e"></span>    <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">done</span>
    println(<span style="color:#e6db74">&#34;main goroutine done&#34;</span>)
}
</code></pre></div><h4 id="producer-consumer">Producer-Consumer</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Producer</span>(<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
    <span style="color:#66d9ef">for</span> {
        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
    }
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Consumer</span>(<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
    <span style="color:#66d9ef">for</span> {
        <span style="color:#a6e22e">v</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span>
        println(<span style="color:#a6e22e">v</span>)
    }
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">2</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">Producer</span>(<span style="color:#a6e22e">ch</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">Producer</span>(<span style="color:#a6e22e">ch</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">Consumer</span>(<span style="color:#a6e22e">ch</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">Consumer</span>(<span style="color:#a6e22e">ch</span>)

    <span style="color:#66d9ef">select</span>{}
}
</code></pre></div><h4 id="pub-sub">Pub-Sub</h4>
<p>å‘å¸ƒè®¢é˜…ä¸ç”Ÿäº§è€…æ¶ˆè´¹è€…ç±»ä¼¼ï¼Œå”¯ä¸€åŒºåˆ«åœ¨äºå‘å¸ƒè®¢é˜…æ¨¡å‹ä¸­ï¼Œå‘å¸ƒè€…ä¸å…³å¿ƒæœ‰å¤šå°‘ä¸ªè®¢é˜…è€…å³æ¯ä¸ªè®¢é˜…è€…éƒ½åº”è¯¥æ”¶åˆ°æ¶ˆæ¯ï¼Œè€Œåœ¨ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œæ¶ˆè´¹è€…æ˜¯é›†ç¾¤æ¶ˆè´¹ï¼ˆé›†ç¾¤æ¶ˆè´¹æ˜¯è¯´æ¯ä¸€æ¡æ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ï¼‰ã€‚ä½¿ç”¨channelä¹Ÿå¯ä»¥å¾ˆç®€å•çš„å®ç°Pub/Subè¿™ç§æ¨¡å‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">topic</span> <span style="color:#66d9ef">struct</span>{
	<span style="color:#a6e22e">chPub</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">chSub</span> []<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">bufsize</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newTopic</span>(<span style="color:#a6e22e">bufsize</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">topic</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">topic</span>{
		<span style="color:#a6e22e">bufsize</span>: <span style="color:#a6e22e">bufsize</span>,
		<span style="color:#a6e22e">chPub</span>:   make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">bufsize</span>),
		<span style="color:#a6e22e">chSub</span>:   make([]<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>),
	}
}

<span style="color:#75715e">// è¿™é‡Œä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼ï¼ï¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">topic</span>) <span style="color:#a6e22e">Sub</span>() <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>  {
	<span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">bufsize</span>)
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">chSub</span> = append(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">chSub</span>, <span style="color:#a6e22e">ch</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ch</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">topic</span>) <span style="color:#a6e22e">Pub</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">chPub</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">v</span>
	<span style="color:#75715e">// åˆ†å‘
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">v2</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">chPub</span>
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">idx</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">chSub</span> {
			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">chSub</span>[<span style="color:#a6e22e">idx</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">v2</span>
		}
	}()
}

<span style="color:#75715e">// Qï¼šå¦‚ä½•å®ç°topicçš„å…³é—­æ–¹æ³•
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">topic</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newTopic</span>(<span style="color:#a6e22e">topic</span>)
	<span style="color:#75715e">// å¼€å¯5ä¸ªè®¢é˜…
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">topic</span>.<span style="color:#a6e22e">Sub</span>()
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ch</span> {
				println(<span style="color:#e6db74">&#34;recv topic&#34;</span>, <span style="color:#a6e22e">v</span>)
			}
		}()
	}
	<span style="color:#75715e">// å‘å¸ƒæ¶ˆæ¯
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">v</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">v</span><span style="color:#f92672">++</span>{
		<span style="color:#a6e22e">topic</span>.<span style="color:#a6e22e">Pub</span>(<span style="color:#a6e22e">v</span>)
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
	}
}
</code></pre></div><h4 id="concurrent-pool">Concurrent Pool</h4>
<p>å¹¶å‘æ§åˆ¶ä¹Ÿæ˜¯channelçš„é‡è¦åº”ç”¨åœºæ™¯ï¼Œåˆ©ç”¨channelä¼šé˜»å¡çš„ç‰¹æ€§ï¼Œå¾—ä»¥æ§åˆ¶æœ€å¤§goroutineæ•°ã€‚åœ¨Webåº”ç”¨ä¸­å¯ä»¥ç”¨äºå®ç°é™æµã€‚ä¸‹é¢å®ç°çš„æ–¹å¼ï¼Œç±»ä¼¼ä¸ä»¤ç‰Œæ¡¶ï¼Œå¦å¤–æ¨èä¸€ä¸ª<a href="https://github.com/yeqown/fasthttp-reverse-proxy/blob/master/channelpool.go">chanpool</a>çš„å®ç°ä»¥ä¾›å‚è€ƒã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">int</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">factory</span>() <span style="color:#a6e22e">obj</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;newobj&#34;</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">pool</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">obj</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newpool</span>() <span style="color:#a6e22e">pool</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pool</span>{
		<span style="color:#a6e22e">ch</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">obj</span>, <span style="color:#ae81ff">10</span>),
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">put</span>(<span style="color:#a6e22e">obj</span>(<span style="color:#a6e22e">i</span>))
	} 
}

<span style="color:#75715e">// éœ€è¦å¢åŠ å¹¶å‘å®‰å…¨ï¼ï¼ï¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">pool</span>) <span style="color:#a6e22e">put</span>(<span style="color:#a6e22e">obj</span> <span style="color:#a6e22e">obj</span>)  {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">obj</span>
}

<span style="color:#75715e">// éœ€è¦å¢åŠ å¹¶å‘å®‰å…¨ï¼ï¼ï¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">pool</span>) <span style="color:#a6e22e">get</span>() <span style="color:#a6e22e">obj</span> {
	<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">ch</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">pool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newpool</span>()

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			println(<span style="color:#e6db74">&#34;num of running g:&#34;</span>, <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">NumGoroutine</span>())
			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
		}
	}()

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">obj</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">get</span>()
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">put</span>(<span style="color:#a6e22e">obj</span>)
			<span style="color:#75715e">// do some work
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)			
		}()
	}
}

<span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span><span style="color:#75715e">// num of running g: 12
</span></code></pre></div><h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æŒæ¡channelçš„åŸç†ï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬åœ¨å®é™…åº”ç”¨ä¸­å¿«é€Ÿå®šä½å’Œåˆ†æå¹¶å‘å¸¦æ¥çš„é—®é¢˜ã€‚ä¹Ÿèƒ½åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œåˆç†åˆ©ç”¨channelã€‚</p>
<blockquote>
<p>æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚</p>
</blockquote>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/">https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/</a></li>
<li><a href="https://github.com/golang/go/tree/release-branch.go1.14">https://github.com/golang/go/tree/release-branch.go1.14</a></li>
<li><a href="https://github.com/eapache/channels">https://github.com/eapache/channels</a></li>
<li><a href="https://colobu.com/2018/03/26/channel-patterns/">https://colobu.com/2018/03/26/channel-patterns/</a></li>
<li><a href="https://juejin.im/post/5decff136fb9a016544bce67">https://juejin.im/post/5decff136fb9a016544bce67</a></li>
<li><a href="https://chai2010.cn/advanced-go-programming-book/ch1-basic/ch1-06-goroutine.html">https://chai2010.cn/advanced-go-programming-book/ch1-basic/ch1-06-goroutine.html</a></li>
</ul>


                            
                            
                            
                            
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section>
      <form method="post" action="post-action">
        <div class="fields">
          <div class="field">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" />
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" />
          </div>
          <div class="field">
            <label for="message">Message</label>
            <textarea name="message" id="message" rows="3"></textarea>
          </div>
        </div>
        <ul class="actions">
          <li><input type="submit" value='Send A Message' /></li>
        </ul>
      </form>
    </section>
    
    <section class="split contact">
        
        <section class="alt">
            <h3>Address</h3>
            <p>
                
                     Chengdu Â· China
                
                     <br/>  This is a city that comes and doesn&#39;t want to go
                
            </p>
        </section>
        
        
        <section>
            <h3>Phone</h3>
            <p><a href="tel:no%20way">no way</a></p>
        </section>
        
        
        <section>
            <h3>Email</h3>
            <p><a href="mailto:yeqown@gmail.com">yeqown@gmail.com</a></p>
        </section>
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/yeqown" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                
                
                
                <li><a href="https://github.com/yeqown" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Yeqown</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
            










<script src='/assets/js/bundle.js'></script>
	</body>
</html>
