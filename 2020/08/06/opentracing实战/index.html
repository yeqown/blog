<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>Opentracingå®æˆ˜ &middot; Yeqown</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		<link rel="shortcut icon" href="favicon.ico">
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
		<link rel="stylesheet" href="/highlight/styles/monokai-sublime.css">
		
		<script src="/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Yeqown</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Yeqown</a></li>
        
        <li><a href='/#footer'>Contact</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/yeqown" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        
        
        
        <li><a href="https://github.com/yeqown" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">August 6, 2020</span>
                                
                                <h1>Opentracingå®æˆ˜</h1>
                                <p>è§£å†³å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé“¾è·¯è¿½è¸ªï¼Œé—®é¢˜å®šä½å’Œå¯è§†åŒ–åˆ†æç­‰é—®é¢˜ï¼Œé“¾è·¯è¿½è¸ªè¿˜æ˜¯å¾®æœåŠ¡å¯è§‚æµ‹æ€§çš„é‡è¦åŸºçŸ³ï¼Œæœ¬æ–‡å°±å®æˆ˜äº†åœ¨Goé¡¹ç›®ä¸­å¦‚ä½•å°†opentracingè½åœ°</p>
                            </header>
                            
                            <h3 id="èƒŒæ™¯">èƒŒæ™¯</h3>
<p>åœ¨æ²¡æœ‰é“¾è·¯è¿½è¸ªç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚æœåªè¦å°‘æ•°å‡ ä¸ªæœåŠ¡ï¼Œæˆ–è®¸è¿˜å¯ä»¥é€šè¿‡æ—¥å¿—æ¥æ’æŸ¥å®šä½é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæœåŠ¡ä¸€æ—¦è¶…è¿‡10ä¸ªï¼Œé‚£ä¹ˆå†æƒ³é€šè¿‡æ—¥å¿—æ¥å®šä½åˆ†æé—®é¢˜å°†æ— æ¯”ç¹çã€‚
å› ä¸ºï¼Œä½ å…ˆè¦ä»å¤§é‡çš„æ—¥å¿—ä¸­åˆ ç­›é€‰å‡ºæŸæ¬¡è¯·æ±‚çš„æ—¥å¿—æ•°æ®ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„å®šä½åˆ†æã€‚
å€˜è‹¥æ—¥å¿—ç³»ç»Ÿä¹Ÿä¸å¤Ÿå®Œå–„ï¼Œæ—¥å¿—å¯¹äºè°ƒè¯•æ¯«æ— å¸®åŠ©ï¼Œé‚£åˆå¾—é€€å›åˆ°æœ€åŸå§‹çš„æ–¹å¼ï¼Œé€šè¿‡ä»£ç æ–­ç‚¹å’Œå¢åŠ æ—¥å¿—ï¼Œç­‰å¾…é—®é¢˜å¤ç°ï¼Œæˆ–è€…é€šè¿‡è‚‰çœ¼æ£€æŸ¥ä»£ç ã€‚
ä¸æ˜¯è¯´è¿™ç§æ–¹å¼ä¸è¡Œï¼Œè€Œæ˜¯å¤§éƒ¨åˆ†çš„ç¨‹åºå‘˜çš„ä¸šåŠ¡éœ€æ±‚æ¯”è¾ƒç´§å¼ ï¼Œè¿™æ ·çš„æ’æŸ¥æ‰‹æ®µæ•ˆç‡å’Œæ”¶ç›Šè¿œè¿œè¾¾ä¸åˆ°è¦æ±‚ï¼ˆå¦‚æœä½ æœ‰æ—¶é—´ï¼Œå½“æˆ‘æ²¡è¯´ ğŸ¶ï¼‰ã€‚</p>
<p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œæˆ‘ä¹Ÿé‡åˆ°äº†è¿™æ ·çš„é—®é¢˜ï¼š</p>
<ol>
<li>æ—¥å¿—ç³»ç»Ÿé‡ŒåŒ…å«äº†è¿‡å°‘çš„ä¿¡æ¯ï¼Œå¯¹äºè°ƒè¯•å‡ ä¹æ²¡æœ‰å¸®åŠ© (å‡ ä¹åªæœ‰é”™è¯¯æ—¥å¿—ï¼Œç¼ºå°‘è¾“å‡ºä¸Šä¸‹æ–‡çš„æ—¥å¿—)ã€‚</li>
<li>æœåŠ¡è°ƒç”¨å¤æ‚ï¼Œä¸€ä¸ªè¯·æ±‚å¤±è´¥ï¼Œåªèƒ½é€è¿‡é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯è¿›è¡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è°ƒç”¨å¤±è´¥çš„æƒ…å†µã€‚</li>
<li>è°ƒç”¨é“¾è·¯å¤æ‚çš„æƒ…å†µä¸‹ï¼Œæƒ³è¦å¯¹æŸä¸ªè¯·æ±‚è¿›è¡Œä¼˜åŒ–ï¼Œæ— ä»ä¸‹æ‰‹ã€‚</li>
</ol>
<p>è¿™é‡Œåªåˆ—ä¸¾äº†è·Ÿ<code>trace</code>ç›¸å…³çš„ä¸€äº›åŸå§‹åœºæ™¯ï¼Œå½“ç„¶ä»ä¸Šé¢çš„æè¿°ä¸­è¿˜èƒ½å‘ç°<code>æ—¥å¿—ç³»ç»Ÿä¸å¤Ÿå®Œå–„ï¼Œå¯¹è°ƒè¯•ä¸å‹å¥½</code>ï¼Œä¸è¿‡è¿™é‡Œé¦–è¦è§£å†³çš„é—®é¢˜æ˜¯<code>é“¾è·¯è¿½è¸ªé—®é¢˜</code>ã€‚</p>
<blockquote>
<p>å¦‚æœå¯¹è·¯é“¾è·¯è¿½è¸ªæ²¡æœ‰æ¦‚å¿µï¼Œè¿˜æœ›è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ï¼Œè¿™é‡Œä¸ä¼šè¿‡å¤šä»‹ç»ï½</p>
</blockquote>
<h3 id="opentracing">Opentracing</h3>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šOpentracing æ˜¯ä¸€å¥—æ ‡å‡†æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°ã€‚</p>
</blockquote>
<p>è¿™é‡Œå°±å®æˆ˜opentracing + jaeger çš„é“¾è·¯è¿½è¸ªæ–¹æ¡ˆã€‚å…¶ä¸­ opentracing æ˜¯ä¸€å¥—æ ‡å‡†æ¥å£ï¼Œè€Œjaegeræ˜¯åŒ…å«äº† opentracing çš„å®ç°çš„ä¸€å¥—å·¥å…·ã€‚
Traceé“¾è·¯ç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<p><img src="/images/tracing1_0.png" /></p>
<h4 id="trace">Trace</h4>
<p>æè¿°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€æ¬¡&quot;äº‹åŠ¡&quot;ã€‚</p>
<h4 id="span">Span</h4>
<p>è¡¨ç¤ºå·¥ä½œæµçš„ä¸€éƒ¨åˆ†çš„å‘½åå’Œå®šæ—¶æ“ä½œã€‚å¯ä»¥æ¥å—æ ‡ç­¾(Tag Key:Value)ï¼Œä»¥åŠé™„åŠ åˆ°ç‰¹å®šspanå®ä¾‹çš„æ ‡æ³¨(Annotation)ï¼Œå¦‚æ—¶é—´æˆ³å’Œç»“æ„åŒ–æ—¥å¿—ã€‚</p>
<h4 id="spancontext">SpanContext</h4>
<p>è¿½è¸ªä¼´éšåˆ†å¸ƒå¼äº‹åŠ¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®ƒé€šè¿‡ç½‘ç»œæˆ–é€šè¿‡æ¶ˆæ¯æ€»çº¿å°†æœåŠ¡ä¼ é€’ç»™æœåŠ¡çš„æ—¶é—´ã€‚spanä¸Šä¸‹æ–‡åŒ…å«TraceIdã€SpanIdå’Œè¿½è¸ªç³»ç»Ÿéœ€è¦ä¼ æ’­åˆ°ä¸‹æ¸¸æœåŠ¡çš„å…¶ä»–æ•°æ®ã€‚</p>
<h3 id="å®æˆ˜">å®æˆ˜</h3>
<p>è¿™é‡Œæˆ‘å‡†å¤‡çš„æ˜¯ Go é¡¹ç›®ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡<code>gRPC</code>é€šä¿¡ã€‚é“¾è·¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">                                +-- process internal trace2
                                |
                     +---&gt; process internal trace1
                     |
                     |                 +---&gt; server-b trace<span style="color:#f92672">(</span>gRPC<span style="color:#f92672">)</span>
entry<span style="color:#f92672">(</span>HTTP<span style="color:#f92672">)</span> ---&gt; server-a trace--gRPC--|
                                       +---&gt; server-c trace<span style="color:#f92672">(</span>gRPC<span style="color:#f92672">)</span>
                                                   |
                                                   +----&gt; process internal trace3
</code></pre></div><p>ä»ä¸Šå›¾ä¸­å¯ä»¥æ˜ç¡®ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šå®è·µ<code>è·¨æœåŠ¡è°ƒç”¨</code>å’Œ<code>æœåŠ¡å†…éƒ¨è°ƒç”¨</code>çš„é“¾è·¯è¿½è¸ªï¼Œé…åˆjaegeræˆ‘ä»¬è¿˜å¯ä»¥å°†é“¾è·¯ä¿¡æ¯å¯è§†åŒ–ã€‚</p>
<h4 id="æˆ‘æœ‰äº†æœåŠ¡æ€ä¹ˆå®æ–½è½åœ°">æˆ‘æœ‰äº†æœåŠ¡ï¼Œæ€ä¹ˆå®æ–½è½åœ°ï¼Ÿ</h4>
<p>ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æŠŠè¿™ä¸ªé—®é¢˜ç»“åˆopentracingçš„æ¦‚å¿µå†åˆ†è§£ä¸€ä¸‹ï¼š</p>
<ol>
<li>ParentSpan ä»å“ªå„¿æ¥ï¼Ÿ</li>
<li>ChildSpanç”±ParentSpanåˆ›å»ºï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ</li>
<li>é“¾è·¯Tracerä»å“ªå„¿æ¥ï¼Ÿ</li>
<li>Traceä¿¡æ¯æ€ä¹ˆä¼ é€’ï¼Ÿ</li>
<li>é“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†ï¼Ÿ</li>
</ol>
<h5 id="parent-span-ä»å“ªå„¿æ¥é“¾è·¯ä»å“ªé‡Œå¼€å§‹">Parent-Span ä»å“ªå„¿æ¥ï¼Ÿé“¾è·¯ä»å“ªé‡Œå¼€å§‹ã€‚</h5>
<p>åœ¨ä¸Šè¿°çš„å®è·µç›®æ ‡ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå…¥å£æœåŠ¡ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾æ¯ä¸€æ¬¡çš„&quot;äº‹åŠ¡&quot;éƒ½æ˜¯åœ¨è¿™ä¸ªå…¥å£ï¼ˆhttp entryï¼‰å¼€å¯çš„ã€‚æˆ‘å†™äº†å¦‚ä¸‹çš„ä¸­é—´ä»¶ï¼ˆåŸºäºginï¼‰ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// è¿™ä¸ªå®šä¹‰æ˜¯å› ä¸ºopentracingæ²¡æœ‰å®šä¹‰è·å–traceId å’ŒspanIdçš„æ–¹æ³•ï¼Œè€Œæˆ‘åˆå®è·µäº† zipkin å’Œ jaeger
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">getTraceID</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">spCtx</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SpanContext</span>) <span style="color:#66d9ef">string</span>

<span style="color:#75715e">// get trace info from header, if not then create an new one
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Opentracing</span>(<span style="color:#a6e22e">getTraceIdFromSpanContext</span> <span style="color:#a6e22e">getTraceID</span>) <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
        <span style="color:#75715e">// prepare work ...
</span><span style="color:#75715e"></span>        
    	<span style="color:#75715e">// è¿™é‡Œé¦–å…ˆå°è¯•ä»å®¢æˆ·ç«¯è¯·æ±‚ä¸­è·å–åˆ°traceé“¾è·¯ä¿¡æ¯ï¼Œå¦‚æœè·å–åˆ°åˆ™åˆ›å»ºchild span.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">carrier</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">HTTPHeadersCarrier</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span>)
        <span style="color:#a6e22e">clientSpCtx</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">Extract</span>(<span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">HTTPHeaders</span>, <span style="color:#a6e22e">carrier</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;could not extract trace data from http header, err=%v\n&#34;</span>, <span style="color:#a6e22e">err</span>)
        }

        <span style="color:#75715e">// derive a span or create an root span
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">sp</span> = <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">StartSpan</span>(
            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">RequestURI</span>,
            <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ChildOf</span>(<span style="color:#a6e22e">clientSpCtx</span>),
        )
        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Finish</span>()
        
        <span style="color:#75715e">// do some work
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        
        <span style="color:#75715e">// å°†å«æœ‰spançš„ context.Context è®¾ç½®åˆ° gin.Context ç”¨äºä¼ é€’span
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ContextWithSpan</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Context</span>(), <span style="color:#a6e22e">sp</span>)
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">_traceContextKey</span>, <span style="color:#a6e22e">ctx</span>)
        <span style="color:#a6e22e">traceId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getTraceIdFromSpanContext</span>(<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Context</span>())
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;X-Trace-Id&#34;</span>, <span style="color:#a6e22e">traceId</span>)
        
        <span style="color:#75715e">// continue process request
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Next</span>()
        
        <span style="color:#75715e">// do some work 
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    }
}
</code></pre></div><h5 id="child-spanä»€ä¹ˆæ—¶å€™åˆ›å»º">Child-Spanä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ</h5>
<p>å…¶å®åœ¨ä¸Šè¿°çš„ä¸­é—´ä»¶é‡Œå·²ç»æœ‰äº†ä½“ç°ï¼ˆè·¨æœåŠ¡è°ƒç”¨æ—¶ï¼‰ã€‚è¿™é‡Œä¸»è¦æœ‰ä¸¤ç§åœºæ™¯ï¼š<code>è·¨æœåŠ¡è°ƒç”¨</code>ï¼Œ<code>æœåŠ¡å†…éƒ¨è°ƒ</code>ï¼Œè¿™ä¸¤ç§çš„åŒºåˆ«åœ¨äºæ˜¯å¦æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ã€‚
é’ˆå¯¹è·¨æœåŠ¡è°ƒç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†gRPCæ¥é€šä¿¡ï¼Œé‚£ä¹ˆåˆ›å»ºçš„æ—¶æœºå°±åœ¨äºgRPCå®¢æˆ·ç«¯å‘èµ·è°ƒç”¨æ—¶ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªchildSpanå¹¶ä¼ é€’ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯éœ€è¦è§£æåˆ°è¯¥spanå¹¶åœ¨å½“æ¬¡è¯·æ±‚ä¸­ä½¿ç”¨ã€‚
è€Œå¯¹äºæœåŠ¡å†…éƒ¨çš„è°ƒç”¨ï¼Œç›¸è¾ƒè€Œè¨€ä¼šæ›´ç®€å•ä¸€ç‚¹ï¼Œç›´æ¥ä½¿ç”¨è¯¥spanåˆ›å»ºchildSpanå°±å¥½äº†ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´åœ¨Goå¼€å‘è¿‡ç¨‹ä¸­æ¨èä½¿ç”¨Contextä½œä¸ºå‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œopentracingä¹Ÿè€ƒè™‘äº†è¿™ä¸€ç‚¹ï¼Œå¦‚ä¸‹ï¼š
å®˜æ–¹æä¾›äº†å¯¹åº”çš„æ–¹æ³•ï¼Œæ¥å¸®åŠ©ä½¿ç”¨è€…æŠŠspanå’Œcontext.Contextä¸€èµ·ä½¿ç”¨ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// ContextWithSpan returns a new `context.Context` that holds a reference to
</span><span style="color:#75715e">// the span. If span is nil, a new context without an active span is returned.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ContextWithSpan</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">span</span> <span style="color:#a6e22e">Span</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">span</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tracerWithHook</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">Tracer</span>().(<span style="color:#a6e22e">TracerContextWithSpanExtension</span>); <span style="color:#a6e22e">ok</span> {
			<span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">tracerWithHook</span>.<span style="color:#a6e22e">ContextWithSpanHook</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">span</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">activeSpanKey</span>, <span style="color:#a6e22e">span</span>)
}

<span style="color:#75715e">// SpanFromContext returns the `Span` previously associated with `ctx`, or
</span><span style="color:#75715e">// `nil` if no such `Span` could be found.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// NOTE: context.Context != SpanContext: the former is Go&#39;s intra-process
</span><span style="color:#75715e">// context propagation mechanism, and the latter houses OpenTracing&#39;s per-Span
</span><span style="color:#75715e">// identity and baggage information.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SpanFromContext</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#a6e22e">Span</span> {
	<span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">activeSpanKey</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sp</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">val</span>.(<span style="color:#a6e22e">Span</span>); <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sp</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>åœ¨ä¸­é—´ä»¶é‚£é‡Œï¼Œæˆ‘ä»¬å·²ç»æŠŠ context.Context è®¾ç½®åˆ°äº† gin.Context ä¸­å»äº†ï¼Œå› æ­¤åœ¨åç»­çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä» gin.Context å–å‡ºå¹¶ä¼ é€’ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// traceHdl is a trace handler from HTTP request
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">traceHdl</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#75715e">// get root Context from request
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO: try to use c.Request.WithContext() to set context
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">GetTraceContextKey</span>())
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
		panic(<span style="color:#e6db74">&#34;impossible&#34;</span>)
	}
	
    <span style="color:#75715e">// ctxåœ¨æœåŠ¡å†…éƒ¨ä¼ é€’ï¼Œctxå«æœ‰spanä¿¡æ¯
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientCall</span>(<span style="color:#a6e22e">ctx</span>.(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#75715e">// response to client
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;traceHdl done&#34;</span>})
}


<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">clientCall</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº†gRPCæ¥åšè·¨æœåŠ¡çš„è°ƒç”¨ï¼Œå¯¹äºctxçš„å¤„ç†ï¼Œæ˜¯é€šè¿‡interceptorå®ç°çš„ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™éƒ¨åˆ†ä»£ç ä¼šåœ¨åé¢è´´ä¸Šï¼Œä½†æ˜¯é€»è¾‘ä¹Ÿè·Ÿç±»ä¼¼ï¼Œåªæ˜¯å¤šäº†éœ€è¦é€‚é…gRPCæ•°æ®ä¼ é€’çš„è§„åˆ™ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serverAConn</span>.<span style="color:#a6e22e">PingA</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">PingAReq</span>{
		<span style="color:#a6e22e">Now</span>:  <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>(),
		<span style="color:#a6e22e">From</span>: <span style="color:#e6db74">&#34;client&#34;</span>,
	})

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// è¿™é‡Œæ¼”ç¤ºè¿›ç¨‹å†…é“¾è·¯
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">processInternalTrace1</span>(<span style="color:#a6e22e">ctx</span>)
}

<span style="color:#75715e">// internal process trace example 1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">processInternalTrace1</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">ctx2</span>, <span style="color:#a6e22e">sp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">StartSpanFromContext</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Finish</span>()

	println(<span style="color:#e6db74">&#34;processInternalTrace1 called&#34;</span>)
	<span style="color:#75715e">// do some ops
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">processInternalTrace2</span>(<span style="color:#a6e22e">ctx2</span>)
}
</code></pre></div><p>gRPC interceptor å®ç°å¦‚ä¸‹ï¼šæœåŠ¡ç«¯å·¥ä½œå†…å®¹ç›¸ä¼¼ï¼Œåªæ˜¯ä»injectæ“ä½œå˜æˆäº†extractã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// client interceptor
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OpenTracingClientInterceptor</span>(<span style="color:#a6e22e">tracer</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#a6e22e">optFuncs</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryClientInterceptor</span> {
	<span style="color:#a6e22e">otgrpcOpts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newOptions</span>()
	<span style="color:#a6e22e">otgrpcOpts</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#a6e22e">optFuncs</span><span style="color:#f92672">...</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(
        <span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,<span style="color:#a6e22e">m</span>
        <span style="color:#a6e22e">ethod</span> <span style="color:#66d9ef">string</span>, 
        <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">resp</span> <span style="color:#66d9ef">interface</span>{}, 
        <span style="color:#a6e22e">cc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ClientConn</span>, 
        <span style="color:#a6e22e">invoker</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryInvoker</span>, 
        <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>,
    ) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">parentCtx</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SpanContext</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">parent</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SpanFromContext</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">parent</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">parentCtx</span> = <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">Context</span>()
        }
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        
        <span style="color:#a6e22e">clientSpan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">StartSpan</span>(
            <span style="color:#a6e22e">method</span>,
            <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ChildOf</span>(<span style="color:#a6e22e">parentCtx</span>),
            <span style="color:#a6e22e">ext</span>.<span style="color:#a6e22e">SpanKindRPCClient</span>,
            <span style="color:#a6e22e">gRPCComponentTag</span>,
        )
        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">clientSpan</span>.<span style="color:#a6e22e">Finish</span>()
        
        <span style="color:#75715e">// æ³¨å…¥
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">injectSpanContext</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">clientSpan</span>)
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        
        <span style="color:#75715e">// è°ƒç”¨
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">invoker</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">method</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
        <span style="color:#75715e">// ...		
</span><span style="color:#75715e"></span>        
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span> 
    }
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">injectSpanContext</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">tracer</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#a6e22e">clientSpan</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Span</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
	<span style="color:#a6e22e">md</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">FromOutgoingContext</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
		<span style="color:#a6e22e">md</span> = <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">New</span>(<span style="color:#66d9ef">nil</span>)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">md</span> = <span style="color:#a6e22e">md</span>.<span style="color:#a6e22e">Copy</span>()
	}
	<span style="color:#a6e22e">mdWriter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metadataReaderWriter</span>{<span style="color:#a6e22e">md</span>}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">Inject</span>(<span style="color:#a6e22e">clientSpan</span>.<span style="color:#a6e22e">Context</span>(), <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">HTTPHeaders</span>, <span style="color:#a6e22e">mdWriter</span>)
	<span style="color:#75715e">// We have no better place to record an error than the Span itself :-/
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">clientSpan</span>.<span style="color:#a6e22e">LogFields</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;event&#34;</span>, <span style="color:#e6db74">&#34;Tracer.Inject() failed&#34;</span>), <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">NewOutgoingContext</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">md</span>)
}
</code></pre></div><p>è‡³æ­¤æˆ‘ä»¬å°±ä»‹ç»å®Œäº†ï¼ŒæœåŠ¡é—´ï¼ˆgRPCï¼‰è°ƒç”¨å’ŒæœåŠ¡å†…ï¼ˆcontextï¼‰è°ƒç”¨çš„childSpançš„åˆ›å»ºå’Œä¼ é€’ã€‚</p>
<h5 id="é“¾è·¯tracerä»å“ªå„¿æ¥">é“¾è·¯Tracerä»å“ªå„¿æ¥ï¼Ÿ</h5>
<p>å…ˆè¯´Traceræœ‰ä»€ä¹ˆç”¨ï¼ŒTraceræ˜¯ç”¨æ¥ç®¡ç†Spançš„ç»Ÿç­¹è€…ï¼Œè´Ÿè´£åˆ›å»ºspanå’Œä¼ æ’­spanã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Tracerè´Ÿè´£åˆ›å»ºspanå’Œä¼ æ’­span
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Tracer</span> <span style="color:#66d9ef">interface</span> {

	<span style="color:#75715e">// Create, start, and return a new Span with the given `operationName` and
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// incorporate the given StartSpanOption `opts`. (Note that `opts` borrows
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// from the &#34;functional options&#34; pattern, per
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// http://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// A Span with no SpanReference options (e.g., opentracing.ChildOf() or
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// opentracing.FollowsFrom()) becomes the root of its own trace.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Examples:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     var tracer opentracing.Tracer = ...
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // The root-span case:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     sp := tracer.StartSpan(&#34;GetFeed&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // The vanilla child span case:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     sp := tracer.StartSpan(
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         &#34;GetFeed&#34;,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.ChildOf(parentSpan.Context()))
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // All the bells and whistles:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     sp := tracer.StartSpan(
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         &#34;GetFeed&#34;,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.ChildOf(parentSpan.Context()),
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.Tag{&#34;user_agent&#34;, loggedReq.UserAgent},
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.StartTime(loggedReq.Timestamp),
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     )
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">StartSpan</span>(<span style="color:#a6e22e">operationName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">StartSpanOption</span>) <span style="color:#a6e22e">Span</span>

	<span style="color:#75715e">// Inject() takes the `sm` SpanContext instance and injects it for
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// propagation within `carrier`. The actual type of `carrier` depends on
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the value of `format`.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// OpenTracing defines a common set of `format` values (see BuiltinFormat),
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// and each has an expected carrier type.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Other packages may declare their own `format` values, much like the keys
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// used by `context.Context` (see https://godoc.org/context#WithValue).
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Example usage (sans error handling):
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     carrier := opentracing.HTTPHeadersCarrier(httpReq.Header)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     err := tracer.Inject(
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         span.Context(),
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.HTTPHeaders,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         carrier)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// NOTE: All opentracing.Tracer implementations MUST support all
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// BuiltinFormats.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Implementations may return opentracing.ErrUnsupportedFormat if `format`
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// is not supported by (or not known by) the implementation.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Implementations may return opentracing.ErrInvalidCarrier or any other
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// implementation-specific error if the format is supported but injection
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// fails anyway.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// See Tracer.Extract().
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Inject</span>(<span style="color:#a6e22e">sm</span> <span style="color:#a6e22e">SpanContext</span>, <span style="color:#a6e22e">format</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">carrier</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>

	<span style="color:#75715e">// Extract() returns a SpanContext instance given `format` and `carrier`.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// OpenTracing defines a common set of `format` values (see BuiltinFormat),
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// and each has an expected carrier type.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Other packages may declare their own `format` values, much like the keys
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// used by `context.Context` (see
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// https://godoc.org/golang.org/x/net/context#WithValue).
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Example usage (with StartSpan):
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     carrier := opentracing.HTTPHeadersCarrier(httpReq.Header)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     clientContext, err := tracer.Extract(opentracing.HTTPHeaders, carrier)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // ... assuming the ultimate goal here is to resume the trace with a
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // server-side Span:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     var serverSpan opentracing.Span
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     if err == nil {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         span = tracer.StartSpan(
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//             rpcMethodName, ext.RPCServerOption(clientContext))
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     } else {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//         span = tracer.StartSpan(rpcMethodName)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//     }
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// NOTE: All opentracing.Tracer implementations MUST support all
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// BuiltinFormats.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Return values:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - A successful Extract returns a SpanContext instance and a nil error
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - If there was simply no SpanContext to extract in `carrier`, Extract()
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//    returns (nil, opentracing.ErrSpanContextNotFound)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - If `format` is unsupported or unrecognized, Extract() returns (nil,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//    opentracing.ErrUnsupportedFormat)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - If there are more fundamental problems with the `carrier` object,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//    Extract() may return opentracing.ErrInvalidCarrier,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//    opentracing.ErrSpanContextCorrupted, or implementation-specific
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//    errors.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// See Tracer.Inject().
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Extract</span>(<span style="color:#a6e22e">format</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">carrier</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">SpanContext</span>, <span style="color:#66d9ef">error</span>)
}
</code></pre></div><p>ä¹‹å‰å·²ç»æåˆ°äº†äº†opentracingæ˜¯ä¸€å¥—æ¥å£ï¼Œé‚£ä¹ˆå…·ä½“çš„å®ç°æ˜¯åœ¨å…¶ä»–çš„å·¥å…·ä¸­å®Œæˆçš„ï¼Œå¦‚jaegerã€‚åˆ›å»ºçš„æ—¶å€™å°±éœ€è¦jaegerçš„æ”¯æŒäº†ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// ä½¿ç”¨jaegeræ¥åˆ›å»ºä¸€ä¸ªtracerï¼Œå¹¶æ³¨å…¥åˆ°opentracingå…¨å±€ä¸­å»
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BootTracerWrapper</span>(<span style="color:#a6e22e">localServiceName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">hostPort</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">xjaeger</span>.<span style="color:#a6e22e">BootJaegerTracer</span>(<span style="color:#a6e22e">localServiceName</span>, <span style="color:#a6e22e">hostPort</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;BootTracerWrapper.BootZipkinTracer&#34;</span>)
	}

    <span style="color:#75715e">// æ³¨å…¥åˆ°å…¨å±€åï¼Œå°±å¯ä»¥é€šè¿‡ opentracing.GlobalTracer() æ¥ä½¿ç”¨ traceräº† 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SetGlobalTracer</span>(<span style="color:#a6e22e">tracer</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BootJaegerTracer</span>(<span style="color:#a6e22e">localServiceName</span>, <span style="color:#a6e22e">hostPort</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Configuration</span>{
		<span style="color:#a6e22e">Sampler</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SamplerConfig</span>{
			<span style="color:#a6e22e">Type</span>:  <span style="color:#a6e22e">jaeger</span>.<span style="color:#a6e22e">SamplerTypeConst</span>,
			<span style="color:#a6e22e">Param</span>: <span style="color:#ae81ff">1</span>,
		},
		<span style="color:#a6e22e">ServiceName</span>: <span style="color:#a6e22e">localServiceName</span>, <span style="color:#75715e">// æœåŠ¡å
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Reporter</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ReporterConfig</span>{
			<span style="color:#a6e22e">LogSpans</span>:          <span style="color:#66d9ef">true</span>,
			<span style="color:#a6e22e">CollectorEndpoint</span>: <span style="color:#a6e22e">_jaegerRecorderEndpoint</span>,
		}, <span style="color:#75715e">// é“¾è·¯æœé›†é…ç½®
</span><span style="color:#75715e"></span>	}

	<span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">NewTracer</span>(
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Logger</span>(<span style="color:#a6e22e">jaegerlog</span>.<span style="color:#a6e22e">StdLogger</span>),
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ZipkinSharedRPCSpan</span>(<span style="color:#66d9ef">true</span>),
	)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;BootJaegerTracer&#34;</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tracer</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h5 id="traceä¿¡æ¯æ€ä¹ˆä¼ é€’">Traceä¿¡æ¯æ€ä¹ˆä¼ é€’ï¼Ÿ</h5>
<p>åœ¨ <a href="#Child-Span%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%88%9B%E5%BB%BA%EF%BC%9F">Child-Spanä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ</a> ä¸­æåˆ°äº† <code>Inject</code>, <code>Extract</code> æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥è¾…åŠ©Traceä¿¡æ¯ä¼ é€’çš„æ–¹æ³•ï¼Œ
å…·ä½“çš„å®ç°ä¹Ÿæ˜¯åœ¨jaegerä¸­å®ç°çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ä»£ç ã€‚</p>
<h5 id="é“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†">é“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†ï¼Ÿ</h5>
<p>åœ¨ <a href="#%E9%93%BE%E8%B7%AFTracer%E4%BB%8E%E5%93%AA%E5%84%BF%E6%9D%A5%EF%BC%9F">#é“¾è·¯Tracerä»å“ªå„¿æ¥</a> å·²ç»æåˆ°äº†jaegeråœ¨åˆ›å»ºtraceræ—¶å¯ä»¥æŒ‡å®šæœé›†å™¨çš„é…ç½®ï¼Œ
å› æ­¤ä¸ŠæŠ¥åŠ¨ä½œä¼šåœ¨jaegerä¸­å®Œæˆï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œæ˜¾å¼è°ƒç”¨ <code>sp.Finish()</code> æ‰ä¼šè§¦å‘ä¸ŠæŠ¥åŠ¨ä½œã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ€ç»ˆå®æˆ˜ç»“æœæˆªå›¾å¦‚ä¸‹ï¼š
å›¾ä¸­åŒ…å«äº†è°ƒç”¨é“¾è·¯å±‚çº§å…³ç³»ï¼Œæ¯ä¸ªç¯èŠ‚çš„è€—æ—¶æƒ…å†µï¼Œè¯·æ±‚çš„å…¥å‚å’Œç»“æœæ•°æ®ï¼ˆå¼‚å¸¸ä¿¡æ¯ï¼Œå¦‚æœ‰ï¼‰ç­‰ã€‚åŒæ—¶è¿˜æ”¯æŒè‡ªå®šä¹‰ï¼ˆTag å’Œ Annotation åŠŸèƒ½ï¼‰ï¼Œ
å¦‚æœè¿˜æƒ³è¦æ›´å¤šçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨è¿™ä¸¤ä¸ªåŠŸèƒ½ç»„åˆæ¥æ»¡è¶³éœ€æ±‚ã€‚</p>
<p><img src="/images/tracing1_2.png" /></p>
<p>å†å¤šçš„æ¡ˆä¾‹å’Œæ–‡æ¡£ï¼Œéƒ½æ²¡æœ‰è‡ªå·±ä¸Šæ‰‹å®è·µçš„æ•ˆæœå¥½ï¼Œå»ºè®®å®é™…è¿è¡Œå¹¶æŸ¥é˜…opentracingæºç ã€‚æ‰€æœ‰çš„ä»£ç å‡å¯åœ¨ <a href="https://github.com/yeqown/opentracing-practice">https://github.com/yeqown/opentracing-practice</a> ä¸­æ‰¾åˆ°ã€‚</p>
<blockquote>
<p>æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚</p>
</blockquote>
<h3 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h3>
<ul>
<li><a href="https://opentracing.io/docs/overview/">https://opentracing.io/docs/overview/</a></li>
<li><a href="https://github.com/opentracing/opentracing-go">https://github.com/opentracing/opentracing-go</a></li>
<li><a href="https://github.com/uber/jaeger-client-go">https://github.com/uber/jaeger-client-go</a></li>
<li><a href="https://github.com/yeqown/opentracing-practice">https://github.com/yeqown/opentracing-practice</a></li>
</ul>


                            
                            
                            
                            
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section>
      <form method="post" action="post-action">
        <div class="fields">
          <div class="field">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" />
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" />
          </div>
          <div class="field">
            <label for="message">Message</label>
            <textarea name="message" id="message" rows="3"></textarea>
          </div>
        </div>
        <ul class="actions">
          <li><input type="submit" value='Send A Message' /></li>
        </ul>
      </form>
    </section>
    
    <section class="split contact">
        
        <section class="alt">
            <h3>Address</h3>
            <p>
                
                     Chengdu Â· China
                
                     <br/>  This is a city that comes and doesn&#39;t want to go
                
            </p>
        </section>
        
        
        <section>
            <h3>Phone</h3>
            <p><a href="tel:no%20way">no way</a></p>
        </section>
        
        
        <section>
            <h3>Email</h3>
            <p><a href="mailto:yeqown@gmail.com">yeqown@gmail.com</a></p>
        </section>
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/yeqown" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                
                
                
                <li><a href="https://github.com/yeqown" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Yeqown</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
            










<script src='/assets/js/bundle.js'></script>
	</body>
</html>
