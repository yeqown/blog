<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>AMQPé‡è¿æœºåˆ¶å®ç° Go &middot; Yeqown</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		<link rel="shortcut icon" href="favicon.ico">
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
		<link rel="stylesheet" href="/highlight/styles/monokai-sublime.css">
		
		<script src="/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Yeqown</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Yeqown</a></li>
        
        <li><a href='/#footer'>Contact</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/yeqown" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        
        
        
        <li><a href="https://github.com/yeqown" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">October 10, 2019</span>
                                
                                <h1>AMQPé‡è¿æœºåˆ¶å®ç° Go</h1>
                                <p>åœ¨ç”Ÿäº§æµ‹è¯•è¿‡ç¨‹ä¸­é¢‘ç¹é‡åˆ°Producerå’ŒConsumeræ— æ³•å‘é€åˆ°RabbitMQçš„é˜Ÿåˆ—ä¸­å»ï¼ŒæŸ¥é˜…æ—¥å¿—åå‘ç°é”™è¯¯â€˜channel/connection is not openâ€™ã€‚ç»“åˆé˜…è¯»AMQPåè®®ï¼Œå› æ­¤å®ç°äº†ä¸€ä¸ª`Wrapper`æ¥æä¾›é‡è¿æœºåˆ¶ã€‚</p>
                            </header>
                            
                            <blockquote>
<p>æ–‡ä¸­ä»£ç åŸºäº <a href="https://github.com/streadway/amqp">https://github.com/streadway/amqp</a> å®ç°ã€‚æ­¤æ–¹å¼ç®€å•æš´åŠ›ï¼Œä½†æ²¡æœ‰åšåˆ°æœ€å°æˆæœ¬è¿ç§»ï¼ˆå¯ä»¥é€‰æ‹©åˆ†åˆ«åŒ…è£…Producerå’ŒConsumerï¼‰ã€‚</p>
</blockquote>
<blockquote>
<p>æ–‡ä¸­æ‰€æœ‰ä»£ç å‚è§ï¼šhttps://github.com/yeqown/infrastructure/tree/master/framework/amqp</p>
</blockquote>
<h2 id="åŸºæœ¬çŸ¥è¯†">åŸºæœ¬çŸ¥è¯†</h2>
<h4 id="amqp">AMQP</h4>
<p><code>AMQP</code>ï¼Œå³<code>Advanced Message Queuing Protocol</code>,ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†,ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚ç”¨ä¸‹å›¾ç®€å•æè¿°ä¸‹AMQPæ¨¡å‹ï¼š</p>
<p><img src="/images/amqp-model.png" alt="AMQP MODEL"></p>
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<h4 id="-é—®é¢˜">-é—®é¢˜</h4>
<p>ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨äº†<code>RabbitMQ</code>åšå¼‚æ­¥æ¶ˆæ¯åˆ†å‘ï¼Œéš”ä¸€æ®µæ—¶é—´ä¼šå‡ºç°ï¼šå‘é€æ¥å£æŠ¥é”™ï¼›å‘é€æˆåŠŸåæœªè¢«æ¶ˆè´¹ç­‰æƒ…å†µã€‚<strong>é‡å¯æœåŠ¡åæ¢å¤</strong>ã€‚</p>
<h4 id="-é—®é¢˜ä»£ç ">-é—®é¢˜ä»£ç </h4>
<p>ç”Ÿäº§è€…ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// producer.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// NewClient .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">RabbitMQConfig</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span> {
    <span style="color:#75715e">// init MQ connection
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Client</span>{
		<span style="color:#a6e22e">ch</span>:  <span style="color:#a6e22e">ch</span>, <span style="color:#75715e">// *amqp.Channel
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cfg</span>: <span style="color:#a6e22e">cfg</span>,
	}
}

<span style="color:#75715e">// Client .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Client</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ch</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Channel</span>
	<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">RabbitMQConfig</span>
}

<span style="color:#75715e">// Send . send by routing 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">payload</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">Payload</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">routing</span> <span style="color:#66d9ef">string</span>

	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">payload</span>.<span style="color:#a6e22e">Typ</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">PayloadTypUsers</span>:
		<span style="color:#a6e22e">routing</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">MqRoutingUser</span>
	<span style="color:#66d9ef">default</span>:
		<span style="color:#a6e22e">routing</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">MqRoutingSys</span>
	}

	<span style="color:#a6e22e">dat</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">payload</span>)
	<span style="color:#a6e22e">publishing</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Publishing</span>{
		<span style="color:#a6e22e">ContentType</span>: <span style="color:#e6db74">&#34;text/plain&#34;</span>,
		<span style="color:#a6e22e">Body</span>:        <span style="color:#a6e22e">dat</span>,
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">Publish</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">MqExchagne</span>, <span style="color:#a6e22e">routing</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">publishing</span>)
}
</code></pre></div><p>æ¶ˆè´¹è€…ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// consumer.go
</span><span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">Consume</span>() <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">initRabbitmqResource</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;could init rabbitmq resource: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">msgs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">rabbitmqChannel</span>.<span style="color:#a6e22e">Consume</span>(
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">rabbitmqQ</span>, <span style="color:#75715e">// queue
</span><span style="color:#75715e"></span>		<span style="color:#e6db74">&#34;&#34;</span>,          <span style="color:#75715e">// consumer
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">false</span>,       <span style="color:#75715e">// auto ack
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">false</span>,       <span style="color:#75715e">// exclusive
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">false</span>,       <span style="color:#75715e">// no local
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">false</span>,       <span style="color:#75715e">// no wait
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">nil</span>,         <span style="color:#75715e">// args
</span><span style="color:#75715e"></span>	)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;could not consume messages: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;start consumming messages&#34;</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">msgs</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;consumming msg: body=%s, ex=%s, routing=%s, content-type=%s&#34;</span>,
			<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Body</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Exchange</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">RoutingKey</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">ContentType</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendout</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Body</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Ack</span>(<span style="color:#66d9ef">false</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;ack message error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
	}

	<span style="color:#75715e">// é˜Ÿåˆ—è¢«åˆ é™¤æ—¶ä¼šè¢«æ‰§è¡Œåˆ°
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Std</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;this should not be executed !!!!!&#34;</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
<span style="color:#75715e">// ...
</span></code></pre></div><h4 id="-åˆ†æé—®é¢˜">-åˆ†æé—®é¢˜</h4>
<p>æœåŠ¡æ•…éšœåï¼Œé¦–å…ˆæŸ¥çœ‹äº†ç”Ÿäº§è€…çš„ç³»ç»Ÿæ—¥å¿—ï¼Œå‘ç°äº† <code>channel/connection is not open</code>ã€‚ä»githubä¸­æ£€ç´¢åå‘ç°https://github.com/streadway/amqp/blob/75d898a42a/channel.go#L155 æœ‰ä¸€ä¸ªé€»è¾‘æ˜¯å¤„ç†å·²ç»å…³é—­çš„<code>channel</code>, ä¼šè§¦å‘<code>ErrClosed = &amp;Error{Code: ChannelError, Reason: &quot;channel/connection is not open&quot;}</code>ï¼Œæ°æ°<em><strong>channelè¢«å…³é—­æ˜¯ä¸Šè¿°ä»£ç æ²¡æœ‰è€ƒè™‘åˆ°çš„é—®é¢˜</strong></em>ã€‚</p>
<p>åœ¨æ¶ˆè´¹è€…è¿™è¾¹çš„é—®é¢˜ï¼Œåœ¨<code>channel</code>è¢«å…³é—­çš„æƒ…å†µä¸‹ï¼Œå°±æ›´æ˜¾çœ¼äº†ï¼š<em><strong>channelè¢«å…³é—­,æ¶ˆè´¹è€…ä¹Ÿå°±è¢«å…³é—­äº†ï¼Œæ¶ˆè´¹çš„goroutineè‡ªç„¶ä¹Ÿé€€å‡ºäº†ï¼Œä¹Ÿå°±å‡ºç°äº†æ¶ˆæ¯æ— æ³•è¢«æ¶ˆè´¹çš„æƒ…å†µ</strong></em>ã€‚å…·ä½“ä»£ç å‚è§ï¼š</p>
<ul>
<li><code>channel.Consume</code> <a href="https://github.com/streadway/amqp/blob/75d898a42a/channel.go#L1049">https://github.com/streadway/amqp/blob/75d898a42a/channel.go#L1049</a></li>
<li><code>consumers.buffer</code> <a href="https://github.com/streadway/amqp/blob/75d898a42a/consumers.go#L54">https://github.com/streadway/amqp/blob/75d898a42a/consumers.go#L54</a></li>
</ul>
<p>å¦‚æœè¿˜æœ‰å…´è¶£å¯ä»¥ç¿»çœ‹ä¸‹<code>connection.shutdown</code>, <code>channel.shutdown</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">subs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">consumers</span>) <span style="color:#a6e22e">buffer</span>(<span style="color:#a6e22e">in</span> <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Delivery</span>, <span style="color:#a6e22e">out</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">Delivery</span>) {
	<span style="color:#75715e">// é€€å‡ºæ—¶å…³é—­æ¶ˆè´¹channel
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">out</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">subs</span>.<span style="color:#a6e22e">Done</span>()

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">inflight</span> = <span style="color:#a6e22e">in</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">queue</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Delivery</span>

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">delivery</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">in</span> {
		<span style="color:#a6e22e">queue</span> = append(<span style="color:#a6e22e">queue</span>, <span style="color:#a6e22e">delivery</span>)

		<span style="color:#66d9ef">for</span> len(<span style="color:#a6e22e">queue</span>) &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">select</span> {
			<span style="color:#75715e">// å¾ˆæ˜æ˜¾ï¼Œåç¨‹ä¼šåœ¨æ¶ˆè´¹è€…è¢«å…³é—­çš„æ—¶å€™é€€å‡º
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">subs</span>.<span style="color:#a6e22e">closed</span>:
				<span style="color:#75715e">// closed before drained, drop in-flight
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">return</span>

			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">delivery</span>, <span style="color:#a6e22e">consuming</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">inflight</span>:
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">consuming</span> {
					<span style="color:#a6e22e">queue</span> = append(<span style="color:#a6e22e">queue</span>, <span style="color:#a6e22e">delivery</span>)
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#a6e22e">inflight</span> = <span style="color:#66d9ef">nil</span>
				}

			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">out</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">queue</span>[<span style="color:#ae81ff">0</span>]:
				<span style="color:#a6e22e">queue</span> = <span style="color:#a6e22e">queue</span>[<span style="color:#ae81ff">1</span>:]
			}
		}
	}
}
</code></pre></div><p>è€Œä¸ºä»€ä¹ˆchannelä¼šè¢«å…³é—­ï¼Œåœ¨ç½‘ä¸Šæ£€ç´¢åå¹¶ç»“åˆä»£ç ï¼š</p>
<table>
<thead>
<tr>
<th>Seq</th>
<th>Description</th>
<th>Reason</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>åº”ç”¨ç¨‹åºä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œç½‘ç»œå¼‚å¸¸è¢«åŠ¨æ–­å¼€è¿æ¥</td>
<td>è¿æ¥ä¸­æ–­</td>
<td>è¿æ¥å…³é—­</td>
</tr>
<tr>
<td>2</td>
<td>é‡æ–°å£°æ˜ç°æœ‰é˜Ÿåˆ—æˆ–å…·æœ‰ä¸åŒ¹é…å±æ€§çš„äº¤æ¢å°†å¤±è´¥</td>
<td>406 PRECONDITION_FAILED</td>
<td>åè®®å¼‚å¸¸</td>
</tr>
<tr>
<td>3</td>
<td>è®¿é—®ä¸å…è®¸ç”¨æˆ·è®¿é—®çš„èµ„æºå°†å¤±è´¥</td>
<td>403 ACCESS_REFUSEDé”™è¯¯</td>
<td>åè®®å¼‚å¸¸</td>
</tr>
<tr>
<td>4</td>
<td>ç»‘å®šä¸å­˜åœ¨çš„é˜Ÿåˆ—æˆ–ä¸å­˜åœ¨çš„äº¤æ¢å°†å¤±è´¥</td>
<td>404 NOT_FOUNDé”™è¯¯</td>
<td>åè®®å¼‚å¸¸</td>
</tr>
<tr>
<td>5</td>
<td>ä»ä¸å­˜åœ¨çš„é˜Ÿåˆ—ä¸­ä½¿ç”¨å°†å¤±è´¥</td>
<td>404 NOT_FOUNDé”™è¯¯</td>
<td>åè®®å¼‚å¸¸</td>
</tr>
<tr>
<td>6</td>
<td>å‘å¸ƒåˆ°ä¸é€€å‡ºçš„äº¤æ¢å°†å¤±è´¥</td>
<td>404 NOT_FOUNDé”™è¯¯</td>
<td>åè®®å¼‚å¸¸</td>
</tr>
<tr>
<td>7</td>
<td>ä»é™¤å£°æ˜è¿æ¥ä»¥å¤–çš„è¿æ¥è®¿é—®ç‹¬å é˜Ÿåˆ—å°†å¤±è´¥</td>
<td>405 RESOURCE_LOCKED</td>
<td>åè®®å¼‚å¸¸</td>
</tr>
</tbody>
</table>
<p>å¾—åˆ°ç»“è®ºï¼šç”±äºç½‘ç»œæ³¢åŠ¨ã€ç”Ÿäº§è€…æ¶ˆè´¹è€…ä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´channelè¢«å…³é—­.</p>
<h2 id="é‡è¿åŸç†">é‡è¿åŸç†</h2>
<pre><code>https://ms2008.github.io/2019/06/16/golang-rabbitmq/ 
https://github.com/streadway/amqp/issues/133
</code></pre>
<p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>channel.NotifyClose</code>å’Œ<code>connection.NotifyClose</code>å¯ä»¥æ¥æ”¶åˆ°é”™è¯¯æ¶ˆæ¯ï¼Œé‚£å°±ä»¥æ­¤ä¸ºé‡è¿çš„è§¦å‘å™¨ã€‚å‡½æ•°åŸå‹ï¼š<code>func NotifyClose(c chan *Error) chan *Error</code>ã€‚å®ç°æ€è·¯å¦‚å›¾ï¼š</p>
<p><img src="/images/amqp-reconnect-process.jpg" alt="AMQP RECONNECT PROCESS">
ç»“åˆ***<a href="#https://github.com/yeqown/infrastructure/tree/master/framework/amqp">CODE</a>***é£Ÿç”¨ï¼Œæ•ˆæœæ›´ä½³å“¦ã€‚<code>handleReconnect</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Wrapper</span>) <span style="color:#a6e22e">handleReconnect</span>() {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">// æœªè¿æ¥ä¸Šçš„æƒ…å†µä¸‹ä¸€ç›´å°è¯•è¿æ¥
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">isConnected</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Attempting to connect&#34;</span>)
			<span style="color:#66d9ef">var</span> (
				<span style="color:#a6e22e">connected</span> = <span style="color:#66d9ef">false</span>
				<span style="color:#a6e22e">err</span>       <span style="color:#66d9ef">error</span>
			)

			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">cnt</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; !<span style="color:#a6e22e">connected</span>; <span style="color:#a6e22e">cnt</span><span style="color:#f92672">++</span> {
				<span style="color:#75715e">// connect å°è¯•è¿æ¥ï¼Œå¹¶åœ¨æˆåŠŸåè§¦å‘changeConnäº‹ä»¶ï¼Œä¹Ÿä¼šæ›´æ–°isConnected
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">connected</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">connect</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Failed to connect: %s.\n&#34;</span>, <span style="color:#a6e22e">err</span>)
				}
				<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">connected</span> {
					<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Retrying... %d\n&#34;</span>, <span style="color:#a6e22e">cnt</span>)
				}
				<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">reconnectDelay</span>)
			}
		}

		<span style="color:#75715e">// è¿æ¥æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œå¤„ç†channel.NotifyClose å’Œ conn.NotifyClose
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// æ³¨ï¼šåœ¨ä»»æ„ä¸€ä¸ªnotifyäº‹ä»¶é€šçŸ¥åï¼Œåº”å®Œå…¨å¤„ç†ä¸¤ä¸ªchannelä¸­çš„æ¶ˆæ¯ï¼Œå¦åˆ™ä¼šé€ æˆæ— ç¼“å†²é˜»å¡ã€‚
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// https://ms2008.github.io/2019/06/16/golang-rabbitmq/
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">done</span>:
			println(<span style="color:#e6db74">&#34;w.done&#34;</span>)
			<span style="color:#66d9ef">return</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">chNotify</span>:
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;channel close notify: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">isConnected</span> = <span style="color:#66d9ef">false</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">connNotify</span>:
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;conn close notify: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">isConnected</span> = <span style="color:#66d9ef">false</span>
		}
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">reconnectDetectDur</span>)
	}
}
</code></pre></div><p>ä»¥ä¸Šã€‚</p>
<blockquote>
<p>æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚</p>
</blockquote>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://github.com/streadway/amqp/issues/133">https://github.com/streadway/amqp/issues/133</a></li>
<li><a href="https://blog.csdn.net/jaredcoding/article/details/78656636">https://blog.csdn.net/jaredcoding/article/details/78656636</a></li>
<li><a href="https://www.cnblogs.com/frankyou/p/5283539.html">https://www.cnblogs.com/frankyou/p/5283539.html</a></li>
<li><a href="https://ms2008.github.io/2019/06/16/golang-rabbitmq/">https://ms2008.github.io/2019/06/16/golang-rabbitmq/</a>ã€å¿…è¯»ã€‘</li>
</ul>


                            
                            
                            
                            
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section>
      <form method="post" action="post-action">
        <div class="fields">
          <div class="field">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" />
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" />
          </div>
          <div class="field">
            <label for="message">Message</label>
            <textarea name="message" id="message" rows="3"></textarea>
          </div>
        </div>
        <ul class="actions">
          <li><input type="submit" value='Send A Message' /></li>
        </ul>
      </form>
    </section>
    
    <section class="split contact">
        
        <section class="alt">
            <h3>Address</h3>
            <p>
                
                     Chengdu Â· China
                
                     <br/>  This is a city that comes and doesn&#39;t want to go
                
            </p>
        </section>
        
        
        <section>
            <h3>Phone</h3>
            <p><a href="tel:no%20way">no way</a></p>
        </section>
        
        
        <section>
            <h3>Email</h3>
            <p><a href="mailto:yeqown@gmail.com">yeqown@gmail.com</a></p>
        </section>
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/yeqown" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                
                
                
                <li><a href="https://github.com/yeqown" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Yeqown</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
            










<script src='/assets/js/bundle.js'></script>
	</body>
</html>
