<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>åŸºäºRepositoryè®¾è®¡ç¼“å­˜æ–¹æ¡ˆ &middot; Yeqown</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		<link rel="shortcut icon" href="favicon.ico">
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
		<link rel="stylesheet" href="/highlight/styles/monokai-sublime.css">
		
		<script src="/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Yeqown</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Yeqown</a></li>
        
        <li><a href='/#footer'>Contact</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/yeqown" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        
        
        
        <li><a href="https://github.com/yeqown" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">November 14, 2019</span>
                                
                                <h1>åŸºäºRepositoryè®¾è®¡ç¼“å­˜æ–¹æ¡ˆ</h1>
                                <p>ç›¸æ¯”äºä½¿ç”¨ä¸€ä¸ªä¸­é—´ä»¶æ¥â€œæš´åŠ›â€ç¼“å­˜æ¥å£çš„å“åº”ï¼Œæé«˜æ¥å£æŸ¥è¯¢é€Ÿåº¦è€Œè¨€ï¼ŒRepositoryç¼“å­˜èƒ½æ›´å¥½çš„æ§åˆ¶ç¼“å­˜ç²’åº¦å’Œæ›´æ–°æ—¶æœºã€‚</p>
                            </header>
                            
                            <h3 id="åœºæ™¯">åœºæ™¯</h3>
<pre><code>Testerâ€”Aï¼šè¿™ä¸ª getInfo æ¥å£å’‹è¿™ä¹ˆæ…¢å‘¢ï¼ŸæŸ¥ä¸€ä¸‹è¦5+sï¼ŸQPSç«Ÿç„¶åªæœ‰10ï¼ï¼ï¼ï¼
RD-B    ï¼šè¿™æ˜¯å› ä¸ºgetInfoè¦æŸ¥åº“ã€‚ã€‚ã€‚Nå¤šåº“
Tester-Bï¼šé‚£ä¼˜åŒ–ä¸€ä¸‹å‘—ï¼Ÿ
RD-B    ï¼šå¥½çš„ï¼Œå®¹æˆ‘æ“ä½œä¸€æ³¢ï¼ˆç»™æ¥å£åŠ ä¸Šä¸€ä¸ªå“åº”ç¼“å­˜ï¼‰ï¼Œå¥½äº†ä½ å†æµ‹è¯•ä¸€ä¸‹
Tester-Bï¼šï¼ˆæµ‹è¯•ä¸­ã€‚ã€‚ã€‚ï¼‰ï¼Œé€Ÿåº¦æœç„¶å¿«äº†ä¸å°‘ã€‚è¯¶ä¸å¯¹ï¼Œè¿™ä¸ªæ¥å£é‡Œæ‹¿åˆ°çš„ç”¨æˆ·ä¿¡æ¯ä¸å¯¹ï¼Œæˆ‘æ˜æ˜å·²ç»balabaäº†ï¼Œè¿™é‡Œæ²¡æœ‰æ›´æ–°ï¼ï¼ï¼
RD-B    ï¼šå“¦å“¦å“¦ï¼Œæˆ‘æ™“å¾—å’¯ï¼Œå†å®¹æˆ‘æ“ä½œä¸€æ³¢ï¼ˆç¼“å­˜åŠ æœ‰æ•ˆæ—¶é—´ï¼Œä¸ªäººä¿¡æ¯æ›´æ–°çš„æ—¶å€™å†å¼ºåˆ ç¼“å­˜ï¼‰ï¼ŒOäº†

è‡³æ­¤å¼€å§‹äº†é’ˆå¯¹äºQPS+ç¼“å­˜æ›´æ–°çš„ä¸€äº›åˆ—æµ‹è¯•ã€‚ã€‚ã€‚å‰§ç»ˆã€‚
</code></pre>
<p>QPSå’Œå“åº”æ—¶é—´æ˜¯åï¼ˆjieï¼‰ç«¯ï¼ˆkou)å·¥ç¨‹å¸ˆéå¸¸ç†Ÿæ‚‰çš„æŒ‡æ ‡ï¼Œè¿™ä¸¤ä¸ªå€¼èƒ½æ¯”è¾ƒç›´è§‚çš„åæ˜ è¯¥æ¥å£çš„æ€§èƒ½ï¼Œ<del>é—´æ¥</del>ç›´æ¥å½±å“äº†å‰ç«¯é¡µé¢çš„æµç•…åº¦ã€‚ã€‚ã€‚</p>
<h3 id="é—®é¢˜æ¥äº†">é—®é¢˜æ¥äº†</h3>
<h4 id="delæ¥å£delæŸ¥è¯¢æ€§èƒ½å¦‚ä½•æé«˜"><del>æ¥å£</del>æŸ¥è¯¢æ€§èƒ½å¦‚ä½•æé«˜</h4>
<p>é™¤å»æœºå™¨å’Œç¼–ç¨‹è¯­è¨€çš„å› ç´ ä¹‹åï¼Œè‚¯å®šè¦ä»ä¸šåŠ¡åœºæ™¯å‡ºå‘ï¼Œåˆ†ææ¥å£å“åº”ç¼“æ…¢çš„åŸå› ã€‚è­¬å¦‚ï¼Œæœ€å¸¸è§çš„:</p>
<ol>
<li>æŸ¥Nå¤šè¡¨ï¼Œè¡¨è¿˜æ²¡æœ‰ç´¢å¼•orz</li>
<li>æ— ç”¨æ•°æ®ï¼Œå¢åŠ ä¼ è¾“çš„Size</li>
<li>åå¤æŸ¥è¯¢æŸäº›<del>çƒ­ç‚¹</del>æ•°æ®ï¼Œä½†æ¯æ¬¡éƒ½ç›´æ¥æ‰“åˆ°æ•°æ®åº“</li>
<li>ä¸Šæ¸¸æœåŠ¡å“åº”ç¼“æ…¢</li>
<li>å…¶ä»–</li>
</ol>
<p>å¥½äº†ï¼Œè¿™é‡Œåªè®¨è®ºçƒ­ç‚¹æ•°æ®çš„ç¼“å­˜æ–¹æ¡ˆï¼Œæ¯•ç«Ÿè¦å…·ä½“åœºæ™¯å…·ä½“åˆ†æï¼Œè€Œç¼“å­˜æ–¹æ¡ˆæ˜¯æ¯”è¾ƒé€šç”¨çš„ã€‚</p>
<h4 id="ç¼“å­˜æ–¹æ¡ˆå¦‚ä½•é€‰æ‹©">ç¼“å­˜æ–¹æ¡ˆå¦‚ä½•é€‰æ‹©</h4>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>ç¼“å­˜æ–¹æ¡ˆ</th>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Responseç¼“å­˜</td>
<td>ç®€å•æš´åŠ›</td>
<td>ç¼“å­˜æ›´æ–°æ—¶æœºä¸å¥½æŠŠæ§ï¼Œå¦‚æœé¢é¢ä¿±åˆ°å¯èƒ½å¿ƒæ€å´©åï¼›ç¼“å­˜ç²’åº¦å¤ªå¤§ï¼Œæ— æ³•å±€éƒ¨æ›´æ–°ï¼›é’ˆå¯¹æŸ¥è¯¢æ¥å£æœ‰å¸®åŠ©ï¼Œå…¶ä»–ä¸šåŠ¡ä¸‹æŸ¥è¯¢æ•°æ®åˆ™æ¯«æ— å¸®åŠ©</td>
</tr>
<tr>
<td>2</td>
<td>Repositoryç¼“å­˜</td>
<td>ç²’åº¦ç”±Repoè‡ªè¡ŒæŒæ¡ï¼Œå¯æ§æ€§å¼ºï¼›Repoå¤ç”¨åœºæ™¯ä¸‹ä¼šæé«˜åº”ç”¨æ•´ä½“çš„é€Ÿåº¦</td>
<td>éœ€è¦é’ˆå¯¹å„ä¸ªRepoåšç¼“å­˜çš„å¤„ç†ï¼›æ”¹åŠ¨è¾ƒå¤šï¼›å…¶ä»–orz</td>
</tr>
</tbody>
</table>
<p>æ€»çš„æ¥è¯´ï¼ŒRepositoryçš„ç¼“å­˜æ–¹æ¡ˆï¼Œåœ¨ä¸Šè¿°èƒŒæ™¯ä¸Šè¾ƒç®€å•æš´åŠ›çš„ä¸­é—´ä»¶ç¼“å­˜æ³•è¦æ›´åŠ ä¼˜é›…å¯æ§ï½ã€‚</p>
<h3 id="ç¼“å­˜ç®—æ³•">ç¼“å­˜ç®—æ³•</h3>
<p>æåˆ°ç¼“å­˜å°±ä¸€å®šä¼šæåˆ°ç¼“å­˜æ›¿æ¢ç­–ç•¥ï¼Œæœ‰æœ€å¸¸è§çš„ï¼š<code>LRU</code> <code>LFU</code> <code>FIFO</code> <code>MRU(æœ€è¿‘é¢‘ç¹ä½¿ç”¨ç®—æ³•)</code> <code>LRUçš„å¤šä¸ªå˜ç§ç®—æ³•</code> <code>LIRS</code>ç­‰ã€‚
è¿™é‡Œé€‰ç”¨äº†LRU-Kï¼ˆK=2ï¼‰å¹¶åŸºäº<code>golang</code>æ¥å®ç° <code>cached-repository</code>ï¼Œæ›´å¤šç®—æ³•çš„è¯¦ç»†ä¿¡æ¯å‚è§å‚è€ƒæ–‡æ¡£ä¸­çš„<a href="https://yeqown.github.io/2019/08/12/LRU%E5%92%8CLRU-K/">LRUå’ŒLRU-K</a>:</p>
<p>è¿™é‡Œåˆ†æˆäº†ä¸¤ä¸ª<code>interface</code>:</p>
<p><code>CacheAlgor</code>é‡ç‚¹åœ¨äºä¸<code>Repo</code>äº¤äº’ï¼Œæ‰€ä»¥åªæä¾›äº†ç®€å•çš„å¢åˆ æ”¹æŸ¥ï¼Œåº•å±‚è¿˜æ˜¯åŸºäº<code>Cache</code>æ¥å®ç°çš„ã€‚æœ¬æ„æ˜¯æƒ³å®ç°å¤šç§ç¼“å­˜æ›¿æ¢ç®—æ³•æ¥ä¸°å¯Œ<code>cached-repository</code>ï¼Œorz</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// cache.go
</span><span style="color:#75715e">// CacheAlgor is an interface implements different alg.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CacheAlgor</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{})
	<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)
	<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{})
	<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{})
}
</code></pre></div><p><code>lru.Cache</code> åœ¨äºæä¾› åŸºäº<code>LRU-like</code>ç®—æ³•ç¼“å­˜å’Œæ›¿æ¢èƒ½åŠ›ï¼Œæ‰€ä»¥æ¥å£ä¼šæ›´ä¸°å¯Œä¸€äº›ï¼Œ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// lru/types.go
</span><span style="color:#75715e">// Cache is the interface for simple LRU cache.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Cache</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Puts a value to the cache, returns true if an eviction occurred and
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// updates the &#34;recently used&#34;-ness of the key.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Returns key&#39;s value from the cache and
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// updates the &#34;recently used&#34;-ness of the key. #value, isFound
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)

	<span style="color:#75715e">// Removes a key from the cache.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Peeks a key
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Returns key&#39;s value without updating the &#34;recently used&#34;-ness of the key.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Peek</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)

	<span style="color:#75715e">// Returns the oldest entry from the cache. #key, value, isFound
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Oldest</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">bool</span>)

	<span style="color:#75715e">// Returns a slice of the keys in the cache, from oldest to newest.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Keys</span>() []<span style="color:#66d9ef">interface</span>{}

	<span style="color:#75715e">// Returns the number of items in the cache.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span>

	<span style="color:#75715e">// iter all key and items in cache
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Iter</span>(<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">IterFunc</span>)

	<span style="color:#75715e">// Clears all cache entries.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Purge</span>()
}
</code></pre></div><p>å…³äºå¦‚ä½•å®ç°<code>LRU</code>æˆ–è€…<code>LRU-K</code>ï¼Œç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šæ–‡ç« äº†ï¼ŒåŸç†ä¹Ÿä¸å¤æ‚ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œç›´æ¥ä¸Šæµ‹è¯•ç»“æœ</p>
<h3 id="ç®€å•æµ‹è¯•">ç®€å•æµ‹è¯•</h3>
<p>å®Œæ•´ä»£ç å‚è§<a href="https://github.com/yeqown/cached-repository/tree/master/examples/custom-cache-manage">code</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// MysqlRepo .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MysqlRepo</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">db</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>
	<span style="color:#a6e22e">calg</span> <span style="color:#a6e22e">cp</span>.<span style="color:#a6e22e">CacheAlgor</span>
	<span style="color:#75715e">// *cp.EmbedRepo
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// NewMysqlRepo .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMysqlRepo</span>(<span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">MysqlRepo</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// func NewLRUK(k, size, hSize uint, onEvict EvictCallback) (*K, error)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lru</span>.<span style="color:#a6e22e">NewLRUK</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;key: %v, value: %v\n&#34;</span>, <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span>)
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MysqlRepo</span>{
        <span style="color:#a6e22e">db</span>:   <span style="color:#a6e22e">db</span>,
        <span style="color:#75715e">// func New(c lru.Cache) CacheAlgor
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">calg</span>: <span style="color:#a6e22e">cp</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">c</span>),
	}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// GetByID .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">MysqlRepo</span>) <span style="color:#a6e22e">GetByID</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">userModel</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;this queryid=%d cost: %d ns\n&#34;</span>,<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">start</span>).<span style="color:#a6e22e">Nanoseconds</span>())
	}()

	<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">id</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">userModel</span>), <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// actual find in DB
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">userModel</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">First</span>(<span style="color:#a6e22e">m</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">m</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Update .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">MysqlRepo</span>) <span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">userModel</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">m</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;before: %v\n&#34;</span>, <span style="color:#a6e22e">m</span>)
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">ID</span> = <span style="color:#a6e22e">id</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">First</span>(<span style="color:#a6e22e">m</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {

	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;after: %v\n&#34;</span>, <span style="color:#a6e22e">m</span>)

	<span style="color:#75715e">// update cache, ifcache hit id
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">m</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Delete .
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">MysqlRepo</span>) <span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">id</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// ... prepare data
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">1000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> uint(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">10</span>))
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
				<span style="color:#66d9ef">continue</span>
			}
	
			<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetByID</span>(<span style="color:#a6e22e">id</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err: %d , %v\n&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
	
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">ID</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">||</span>
				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;name-%d&#34;</span>, <span style="color:#a6e22e">id</span>) <span style="color:#f92672">||</span>
				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Province</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;province-%d&#34;</span>, <span style="color:#a6e22e">id</span>) <span style="color:#f92672">||</span>
				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">City</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;city-%d&#34;</span>, <span style="color:#a6e22e">id</span>) {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err: not matched target with id[%d]: %v\n&#34;</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">v</span>)
			}
			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
		}()
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">âœ  custom-cache-manage git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> âœ— go run main.go 
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">245505</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">131838</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">128272</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">112281</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">123942</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">140267</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">148814</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">126904</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">129676</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">174202</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">151673</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">156370</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">159285</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">142215</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">691</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">450</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">160263</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">149655</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">756</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">143363</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">740</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">558</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">476</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">184098</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">824</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">556</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">632</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">480</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">439</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">409</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">431</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">479</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">423</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">423</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">411</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">423</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">394</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">410</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">424</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">428</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">433</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">420</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">424</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">406</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">399</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">405</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">428</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">383</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">399</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">413</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">381</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">427</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">430</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">468</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">406</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">380</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">360</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">660</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">393</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">419</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">1254</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">723</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">503</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">448</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">510</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">432</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">999</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">419</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">658</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">1322</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">543</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">1311</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">348</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">309</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">350</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">311</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">336</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">567</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">293</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">338</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">499</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">318</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">330</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">322</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">339</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">1273</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">1175</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">306</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">316</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">330</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">322</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">324</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">291</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">310</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">321</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">294</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">293</span> ns
this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">3566</span> ns
...more ignored
</code></pre></div><blockquote>
<p>æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚</p>
</blockquote>
<h3 id="ä»£ç ">ä»£ç </h3>
<p><a href="https://github.com/yeqown/cached-repository">github.com/yeqown/cached-repository</a></p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1005742">LIRS</a></li>
<li><a href="https://yeqown.github.io/2019/08/12/LRU%E5%92%8CLRU-K/">LRU-k</a></li>
</ul>


                            
                            
                            
                            
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section>
      <form method="post" action="post-action">
        <div class="fields">
          <div class="field">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" />
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" />
          </div>
          <div class="field">
            <label for="message">Message</label>
            <textarea name="message" id="message" rows="3"></textarea>
          </div>
        </div>
        <ul class="actions">
          <li><input type="submit" value='Send A Message' /></li>
        </ul>
      </form>
    </section>
    
    <section class="split contact">
        
        <section class="alt">
            <h3>Address</h3>
            <p>
                
                     Chengdu Â· China
                
                     <br/>  This is a city that comes and doesn&#39;t want to go
                
            </p>
        </section>
        
        
        <section>
            <h3>Phone</h3>
            <p><a href="tel:no%20way">no way</a></p>
        </section>
        
        
        <section>
            <h3>Email</h3>
            <p><a href="mailto:yeqown@gmail.com">yeqown@gmail.com</a></p>
        </section>
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/yeqown" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                
                
                
                <li><a href="https://github.com/yeqown" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Yeqown</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
            










<script src='/assets/js/bundle.js'></script>
	</body>
</html>
